<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Mitchell Kember">
  <title>SICP Section 3.5 Notes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
   var mathElements = document.getElementsByClassName("math");
   var macros = [];
   for (var i = 0; i < mathElements.length; i++) {
    var texText = mathElements[i].firstChild;
    if (mathElements[i].tagName == "SPAN") {
     katex.render(texText.data, mathElements[i], {
      displayMode: mathElements[i].classList.contains('display'),
      throwOnError: false,
      macros: macros,
      fleqn: false
     });
  }}});
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" />
  <link rel="stylesheet" href="../../assets/style.css">
</head>
<body>
<div hidden>
  <svg>
    <symbol id="up" viewBox="0 0 11 12">
      <path fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M5.5.8v10.4m4.457-5.943L5.5.8 1.043 5.257"/>
    </symbol>
    <symbol id="left" viewBox="0 0 12 11">
      <path fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M.8 5.5h10.4M5.257 9.957L.8 5.5l4.457-4.457">
    </symbol>
    <symbol id="right" viewBox="0 0 12 11">
      <use xlink:href="#left" transform="matrix(-1 0 0 1 12 0)"/>
    </symbol>    <symbol id="external" viewBox="0 0 24 24">
               <path fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" d="M10.688 5.438H4.125A2.65 2.65 0 001.5 8.063v11.812A2.65 2.65 0 004.125 22.5h11.813a2.65 2.65 0 002.624-2.625v-6.563m-9.187 1.313L22.5 1.5m-6.563 0H22.5v6.563"/>
             </symbol>    <symbol id="circle-left" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
               <circle cx="12" cy="12" r="9" stroke-width="1.69" transform="matrix(.8889 0 0 .8889 -1.667 -1.667)"/>
               <path stroke-width="1.5" d="M5.229 9h7.542M9 5.229L5.229 9 9 12.771"/>
             </symbol>
  </svg>
</div>
<a class="skip-link" href="#main">Skip to main content</a>
<header class="header">
  <a class="title link" href="../../index.html">SICP Study</a>
  <nav class="sitenav" aria-label="site">
    <a class="sitenav__item sitenav__item--active link"
        href="../../text/index.html" aria-label="textbook notes">Text</a>
    <a class="sitenav__item link"
        href="../../lecture/index.html" aria-label="lecture notes">Lecture</a>
    <a class="sitenav__item link"
        href="../../exercise/index.html" aria-label="exercises">Exercise</a>
    <a class="sitenav__item sitenav__item--last link"
        href="https://github.com/mk12/sicp" aria-label="GitHub repository">
      Source
      <svg alt="" class="github-mark" width="25" height="25" viewBox="0 0 136 133">
        <path fill="currentColor" d="M67.866.002C30.387.002 0 30.39 0 67.877c0 29.988 19.446 55.425 46.417 64.404 3.396.621 4.633-1.475 4.633-3.275 0-1.608-.058-5.879-.091-11.541-18.88 4.1-22.863-9.1-22.863-9.1-3.087-7.838-7.537-9.925-7.537-9.925-6.163-4.213.466-4.13.466-4.13 6.813.484 10.396 6.996 10.396 6.996 6.054 10.371 15.888 7.375 19.754 5.642.617-4.387 2.367-7.38 4.309-9.075-15.071-1.712-30.917-7.537-30.917-33.546 0-7.408 2.646-13.466 6.988-18.212-.7-1.717-3.03-8.617.662-17.963 0 0 5.7-1.825 18.667 6.959 5.412-1.505 11.22-2.259 16.992-2.284 5.762.025 11.57.78 16.991 2.284 12.959-8.784 18.646-6.959 18.646-6.959 3.704 9.346 1.375 16.246.675 17.963 4.35 4.746 6.98 10.804 6.98 18.212 0 26.075-15.872 31.813-30.992 33.492 2.437 2.096 4.608 6.237 4.608 12.57 0 9.072-.083 16.392-.083 18.617 0 1.817 1.22 3.93 4.666 3.267 26.95-8.996 46.38-34.417 46.38-64.396 0-37.487-30.392-67.875-67.88-67.875"/>
      </svg>      
    </a>
  </nav>
</header>
<nav class="pagenav pagenav--top" aria-label="page">
  <div class="pagenav__item pagenav__item--left">
    <a class="pagenav__link link" href="4.html" aria-label="previous page">
      <svg alt="" width="12" height="11"><use xlink:href="#left"/>
      </svg><span class="pagenav__prev">Prev</span>
    </a>
  </div>
  <div class="pagenav__item pagenav__item--center">
    <a class="pagenav__link link" href="index.html" aria-label="parent page">
      <svg alt="" width="11" height="12"><use xlink:href="#up"/>
      </svg><span class="pagenav__up">Up</span>
    </a>
  </div>
  <div class="pagenav__item pagenav__item--right">
    <a class="pagenav__link link" href="../4/index.html" aria-label="next page">
      <span class="pagenav__next">Next</span
        ><svg alt="" width="12" height="11"><use xlink:href="#right"/></svg>
    </a>
  </div>
</nav>
<main id="main">
<article>
<h1>
<span class="number">3.5</span> <a class="link" href="https://mitpress.mit.edu/sites/default/files/sicp/full-text/book/book-Z-H-24.html">Streams<span class="nowrap">﻿<svg alt="" class="external" width="24" height="24"><use xlink:href="#external"/></svg></span></a>
</h1>
<ul>
<li>We’ve used assignment as a powerful tool and dealt with some of the complex problems it raises.</li>
<li>Now we will consider another approach to modeling state, using data structures called <em>streams</em>.</li>
<li>We want to avoid identifying time in the computer with time in the modeled world.</li>
<li>If <span class="math inline">x</span> is a function of time <span class="math inline">x(t)</span>, we can think of the identity <span class="math inline">x</span> as a history of values (and these don’t change).</li>
<li>With time measured in discrete steps, we can model a time function as a sequence of values.</li>
<li>Stream processing allows us to model state without assignments.</li>
</ul>
<h2 id="3.5.1" class="anchor">
<a class="anchor__link link" href="#3.5.1" aria-hidden="true">#</a><span class="number">3.5.1</span> <a class="link" href="https://mitpress.mit.edu/sites/default/files/sicp/full-text/book/book-Z-H-24.html#%_sec_3.5.1">Streams Are Delayed Lists<span class="nowrap">﻿<svg alt="" class="external" width="24" height="24"><use xlink:href="#external"/></svg></span></a>
</h2>
<ul>
<li>If we represent streams as lists, we get elegance at the price of severe inefficiency (time <em>and</em> space).</li>
<li>Consider adding all the primes in an interval. Using <code class="sourceCode scheme"><span class="fu">filter</span></code> and <code class="sourceCode scheme">reduce</code>, we waste a lot of space storing lists.</li>
<li>Streams are lazy lists. They are the clever idea of using sequence manipulations without incurring the cost.</li>
<li>We only construct an item of the stream when it is needed.</li>
<li>We have <code class="sourceCode scheme"><span class="kw">cons-stream</span></code>, <code class="sourceCode scheme">stream-car</code>, <code class="sourceCode scheme">stream-cdr</code>, <code class="sourceCode scheme">the-empty-stream</code>, and <code class="sourceCode scheme">stream-null?</code>.</li>
<li>The <code class="sourceCode scheme"><span class="kw">cons-stream</span></code> procedure must not evaluate its second argument until it is accessed by <code class="sourceCode scheme">stream-cdr</code>.</li>
<li>To implement streams, we will use <em>promises</em>. <code class="sourceCode scheme">(<span class="kw">delay</span> <span class="sc">«</span><span class="ss">exp</span><span class="sc">»</span>)</code> does not evaluate the argument but returns a promise. <code class="sourceCode scheme">(<span class="fu">force</span> <span class="sc">«</span><span class="ss">promise</span><span class="sc">»</span>)</code> evaluates a promise and returns the value.</li>
<li><code class="sourceCode scheme">(<span class="kw">cons-stream</span> a b)</code> is a special form equivalent to <code class="sourceCode scheme">(<span class="fu">cons</span> a (<span class="kw">delay</span> b))</code>.</li>
</ul>
<h3 id="3.5.1.1" class="anchor">
<a class="anchor__link link" href="#3.5.1.1" aria-hidden="true">#</a>The stream implementation in action
</h3>
<blockquote>
<p>In general, we can think of delayed evaluation as “demand-driven” programming, we herby each stage in the stream process is activated only enough to satisfy the next stage. (438)</p>
</blockquote>
<h3 id="3.5.1.2" class="anchor">
<a class="anchor__link link" href="#3.5.1.2" aria-hidden="true">#</a>Implementing <code>delay</code> and <code>force</code>
</h3>
<ul>
<li>Promises are quite straightforward to implement.</li>
<li><code class="sourceCode scheme">(<span class="kw">delay</span> <span class="sc">«</span><span class="ss">exp</span><span class="sc">»</span>)</code> is syntactic sugar for <code class="sourceCode scheme">(<span class="kw">lambda</span> () <span class="sc">«</span><span class="ss">exp</span><span class="sc">»</span>)</code>.</li>
<li><code class="sourceCode scheme"><span class="fu">force</span></code> simply calls the procedure. We can optimize it by saving the result and not calling the procedure a second time.</li>
<li>The promise stored in the <code class="sourceCode scheme"><span class="fu">cdr</span></code> of the stream is also known as a <em>thunk</em>.</li>
</ul>
<h2 id="3.5.2" class="anchor">
<a class="anchor__link link" href="#3.5.2" aria-hidden="true">#</a><span class="number">3.5.2</span> <a class="link" href="https://mitpress.mit.edu/sites/default/files/sicp/full-text/book/book-Z-H-24.html#%_sec_3.5.2">Infinite Streams<span class="nowrap">﻿<svg alt="" class="external" width="24" height="24"><use xlink:href="#external"/></svg></span></a>
</h2>
<ul>
<li>With lazy sequences, we can manipulate infinitely long streams!</li>
<li>We can define Fibonacci sequence explicitly with a generator:</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">define</span> (fibgen a b) (<span class="kw">cons-stream</span> a (fibgen b (<span class="fu">+</span> a b))))</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">define</span> fibs (fibgen <span class="cn">0</span> <span class="cn">1</span>))</span></code></pre></div>
<ul>
<li>As long as we don’t try to display the whole sequence, we will never get stuck in an infinite loop.</li>
<li>We can also create an infinite stream of primes.</li>
</ul>
<h3 id="3.5.2.1" class="anchor">
<a class="anchor__link link" href="#3.5.2.1" aria-hidden="true">#</a>Defining streams implicitly
</h3>
<ul>
<li>Instead of using a generator procedure, we can define infinite streams implicitly, taking advantage of the laziness.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">define</span> fibs</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cons-stream</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>   <span class="cn">0</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">cons-stream</span> <span class="cn">1</span> (stream-map <span class="fu">+</span> fibs (stream-cdr fibs)))))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">define</span> pot</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cons-stream</span> <span class="cn">1</span> (stream-map (<span class="kw">lambda</span> (x) (<span class="fu">*</span> x <span class="cn">2</span>)) pot)))</span></code></pre></div>
<ul>
<li>This implicit technique is known as <em>corecursion</em>. Recursion works backward towards a base case, but corecursion works from the base and creates more data in terms of itself.</li>
</ul>
<h2 id="3.5.3" class="anchor">
<a class="anchor__link link" href="#3.5.3" aria-hidden="true">#</a><span class="number">3.5.3</span> <a class="link" href="https://mitpress.mit.edu/sites/default/files/sicp/full-text/book/book-Z-H-24.html#%_sec_3.5.3">Exploiting the Stream Paradigm<span class="nowrap">﻿<svg alt="" class="external" width="24" height="24"><use xlink:href="#external"/></svg></span></a>
</h2>
<ul>
<li>Streams can provide many of the benefits of local state and assignment while avoiding some of the theoretical tangles.</li>
<li>Using streams allows us to have different module boundaries.</li>
<li>We can focus on the whole stream/series/signal rather than on individual values.</li>
</ul>
<h3 id="3.5.3.1" class="anchor">
<a class="anchor__link link" href="#3.5.3.1" aria-hidden="true">#</a>Formulating iterations as stream processes
</h3>
<ul>
<li>Before, we made iterative processes by updating state variables in recursive calls.</li>
<li>To compute the square root, we improved a guess until the values didn’t change very much.</li>
<li>We can make a stream that converges on the square root of <code class="sourceCode scheme">x</code>, and a stream to approximate <span class="math inline">π</span>.</li>
<li>One neat thing we can do with these streams is use sequence accelerators, such as Euler’s transform.</li>
</ul>
<h3 id="3.5.3.2" class="anchor">
<a class="anchor__link link" href="#3.5.3.2" aria-hidden="true">#</a>Infinite streams of pairs
</h3>
<ul>
<li>Previously, we handled traditional nested loops as processes defined on sequences of pairs.</li>
<li>We can find all pairs <span class="math inline">(i,j)</span> with <span class="math inline">i ≤ j</span> such that <span class="math inline">i + j</span> is prime like this:</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>(stream-filter</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a> (<span class="kw">lambda</span> (pair) (prime? (<span class="fu">+</span> (<span class="fu">car</span> pair) (<span class="fu">cadr</span> pair))))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a> int-pairs)</span></code></pre></div>
<ul>
<li>We need some way of producing a stream of all integer pairs.</li>
<li>More generally, we can combined two streams to get a two-dimensional grid of pairs, and we want to reduce this to a one-dimensional stream.</li>
<li>One way to do this is to use <code class="sourceCode scheme">interleave</code> in the recursive definition, in order to handle infinite streams.</li>
</ul>
<h3 id="3.5.3.3" class="anchor">
<a class="anchor__link link" href="#3.5.3.3" aria-hidden="true">#</a>Streams as signals
</h3>
<ul>
<li>We can use streams to model signal-processing systems.</li>
<li>For example, taking the integral of a signal:</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">define</span> (integral integrand initial-value dt)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">define</span> int</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cons-stream</span> initial-value</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                 (add-streams (scale-stream integrand dt)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                              int)))</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  int)</span></code></pre></div>
<h2 id="3.5.4" class="anchor">
<a class="anchor__link link" href="#3.5.4" aria-hidden="true">#</a><span class="number">3.5.4</span> <a class="link" href="https://mitpress.mit.edu/sites/default/files/sicp/full-text/book/book-Z-H-24.html#%_sec_3.5.4">Streams and Delayed Evaluation<span class="nowrap">﻿<svg alt="" class="external" width="24" height="24"><use xlink:href="#external"/></svg></span></a>
</h2>
<ul>
<li>The use of <code class="sourceCode scheme"><span class="kw">delay</span></code> in <code class="sourceCode scheme"><span class="kw">cons-stream</span></code> is crucial to defining streams with feedback loops.</li>
<li>However, there are cases where we need further, explicit uses of <code class="sourceCode scheme"><span class="kw">delay</span></code>.</li>
<li>For example, solving the differential equation <span class="math inline">dy/dt = f(y)</span> where <span class="math inline">f</span> is a given function.</li>
<li>The problem here is that <code class="sourceCode scheme">y</code> and <code class="sourceCode scheme">dy</code> will depend on each other.</li>
<li>To solve this, we need to change <code class="sourceCode scheme">integral</code> to take a delayed integrand.</li>
</ul>
<h3 id="3.5.4.1" class="anchor">
<a class="anchor__link link" href="#3.5.4.1" aria-hidden="true">#</a>Normal-order evaluation
</h3>
<ul>
<li>Explicit use of <code class="sourceCode scheme"><span class="kw">delay</span></code> and <code class="sourceCode scheme"><span class="fu">force</span></code> is powerful, but makes our programs more complex.</li>
<li>It creates two classes of procedures: normal, and ones that take delayed arguments.</li>
<li>(This is similar to the sync vs. async divide in modern programming languages.)</li>
<li>This forces us to define separate classes of higher-order procedures, unless we make everything delayed, equivalent to normal-order evaluation (like Haskell).</li>
<li>Mutability and delayed evaluation do not mix well.</li>
</ul>
<h2 id="3.5.5" class="anchor">
<a class="anchor__link link" href="#3.5.5" aria-hidden="true">#</a><span class="number">3.5.5</span> <a class="link" href="https://mitpress.mit.edu/sites/default/files/sicp/full-text/book/book-Z-H-24.html#%_sec_3.5.5">Modularity of Functional Programs and Modularity of Objects<span class="nowrap">﻿<svg alt="" class="external" width="24" height="24"><use xlink:href="#external"/></svg></span></a>
</h2>
<ul>
<li>Modularity through encapsulation is a major benefit of introducing assignment.</li>
<li>Stream models can provide equivalent modularity without assignment.</li>
<li>For example, we can reimplement the Monte Carlo simulation with streams.</li>
</ul>
<h3 id="3.5.5.1" class="anchor">
<a class="anchor__link link" href="#3.5.5.1" aria-hidden="true">#</a>A functional-programming view of time
</h3>
<ul>
<li>Streams represent time explicitly, decoupling the simulated world from evaluation.</li>
<li>They produce stateful-seeming behavior but avoid all the thorny issues of state.</li>
<li>However, the issues come back when we need to merge streams together.</li>
<li>Immutability is a key pillar of <em>functional programming languages</em>.</li>
</ul>
<div id="q1" class="highlight" aria-label="Highlighted ">
<a class="highlight__link link" href="../highlight.html#3.5-q1" aria-label="View quote in highlights page"><svg alt="" class="circle-arrow" width="18" height="18"><use xlink:href="#circle-left"/></svg> Highlights</a>
<blockquote>
<p>We can model the world as a collection of separate, time-bound, interacting objects with state, or we can model the world as a single, timeless, stateless unity. Each view has powerful advantages, but neither view alone is completely satisfactory. A grand unification has yet to emerge.</p>
<p>The object model approximates the world by dividing it into separate pieces. The functional model does not modularize along object boundaries. The object model is useful when the unshared state of the “objects” is much larger than the state that they share. <span class="citation" data-cites="sicp">[@sicp 3.5.5]</span></p>
</blockquote>
</div>
<!-- https://mitpress.mit.edu/sites/default/files/sicp/full-text/book/book-Z-H-24.html#footnote_Temp_507 -->
<!-- Footnote is only 2nd paragraph. -->
</article>
</main>
<nav class="pagenav pagenav--bottom" aria-label="page">
  <div class="pagenav__item pagenav__item--left">
    <a class="pagenav__link link" href="4.html" aria-label="previous page">
      <svg alt="" width="12" height="11"><use xlink:href="#left"/>
      </svg><span class="pagenav__prev">Prev</span>
    </a>
  </div>
  <div class="pagenav__item pagenav__item--center">
    <a class="pagenav__link link" href="index.html" aria-label="parent page">
      <svg alt="" width="11" height="12"><use xlink:href="#up"/>
      </svg><span class="pagenav__up">Up</span>
    </a>
  </div>
  <div class="pagenav__item pagenav__item--right">
    <a class="pagenav__link link" href="../4/index.html" aria-label="next page">
      <span class="pagenav__next">Next</span
        ><svg alt="" width="12" height="11"><use xlink:href="#right"/></svg>
    </a>
  </div>
</nav>
<footer class="footer">
  <p>© 2020 Mitchell Kember</p>
</footer>
</body>
</html>
