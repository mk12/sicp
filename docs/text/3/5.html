<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Mitchell Kember">
  <title>SICP Section 3.5 Notes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
   var mathElements = document.getElementsByClassName("math");
   var macros = [];
   for (var i = 0; i < mathElements.length; i++) {
    var texText = mathElements[i].firstChild;
    if (mathElements[i].tagName == "SPAN") {
     katex.render(texText.data, mathElements[i], {
      displayMode: mathElements[i].classList.contains('display'),
      throwOnError: false,
      macros: macros,
      fleqn: false
     });
  }}});
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" />
  <link rel="stylesheet" href="../../assets/style.css">
</head>
<body>
<header class="header ">
  <a class="title link" href="../../index.html">SICP Study</a>
  <span class="gap"></span>
  <nav class="sitenav">
    <a class="sitenav__item link  sitenav__item--active"
      href="../../text/index.html">Text</a>
    <a class="sitenav__item link "
      href="../../lecture/index.html">Lecture</a>
    <a class="sitenav__item link "
      href="../../exercise/index.html">Exercise</a>
    <a class="sitenav__item link" href="https://github.com/mk12/sicp">
      Source&nbsp;<svg class="github-mark" width="25" height="25" viewBox="0 0 136 133">
  <g transform="matrix(1,0,0,1,-568.001,-447.669)">
    <g transform="matrix(4.16667,0,0,4.16667,0,0)">
      <g transform="matrix(1,0,0,1,152.608,139.345)">
        <path d="M0,-31.904C-8.995,-31.904 -16.288,-24.611 -16.288,-15.614C-16.288,-8.417 -11.621,-2.312 -5.148,-0.157C-4.333,-0.008 -4.036,-0.511 -4.036,-0.943C-4.036,-1.329 -4.05,-2.354 -4.058,-3.713C-8.589,-2.729 -9.545,-5.897 -9.545,-5.897C-10.286,-7.778 -11.354,-8.279 -11.354,-8.279C-12.833,-9.29 -11.242,-9.27 -11.242,-9.27C-9.607,-9.154 -8.747,-7.591 -8.747,-7.591C-7.294,-5.102 -4.934,-5.821 -4.006,-6.237C-3.858,-7.29 -3.438,-8.008 -2.972,-8.415C-6.589,-8.826 -10.392,-10.224 -10.392,-16.466C-10.392,-18.244 -9.757,-19.698 -8.715,-20.837C-8.883,-21.249 -9.442,-22.905 -8.556,-25.148C-8.556,-25.148 -7.188,-25.586 -4.076,-23.478C-2.777,-23.839 -1.383,-24.02 0.002,-24.026C1.385,-24.02 2.779,-23.839 4.08,-23.478C7.19,-25.586 8.555,-25.148 8.555,-25.148C9.444,-22.905 8.885,-21.249 8.717,-20.837C9.761,-19.698 10.392,-18.244 10.392,-16.466C10.392,-10.208 6.583,-8.831 2.954,-8.428C3.539,-7.925 4.06,-6.931 4.06,-5.411C4.06,-3.234 4.04,-1.477 4.04,-0.943C4.04,-0.507 4.333,0 5.16,-0.159C11.628,-2.318 16.291,-8.419 16.291,-15.614C16.291,-24.611 8.997,-31.904 0,-31.904"/>
      </g>
    </g>
  </g>
</svg>
    </a>
  </nav>
</header>
<nav class="pagenav pagenav--top">
  <div class="pagenav__item pagenav__item--prev">
    <a class="pagenav__link link" href="4.html">
      <svg class="arrow" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <line x1="5" y1="12" x2="19" y2="12"/>
  <line x1="5" y1="12" x2="11" y2="18"/>
  <line x1="5" y1="12" x2="11" y2="6"/>
</svg>&nbsp;Prev
    </a>
  </div>
  <div class="pagenav__item pagenav__item--up">
    <a class="pagenav__link link" href="index.html"><svg class="arrow" width="18" height="18" viewBox="0 0 24 24" stroke-width="1.75" stroke="currentColor" fill="none">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <line x1="12" y1="5" x2="12" y2="19"/>
  <line x1="18" y1="11" x2="12" y2="5"/>
  <line x1="6" y1="11" x2="12" y2="5"/>
</svg>&nbsp;Up</a>
  </div>
  <div class="pagenav__item pagenav__item--next">
    <a class="pagenav__link link" href="../4/index.html">
      Next&nbsp;<svg class="arrow" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <line x1="5" y1="12" x2="19" y2="12"/>
  <line x1="13" y1="18" x2="19" y2="12"/>
  <line x1="13" y1="6" x2="19" y2="12"/>
</svg>
    </a>
  </div>
</nav>
<h1>
<small class="number">3.5</small>Streams
</h1>
<ul>
<li>We’ve used assignment as a powerful tool and dealt with some of the complex problems it raises.</li>
<li>Now we will consider another approach to modeling state, using data structures called <em>streams</em>.</li>
<li>We want to avoid identifying time in the computer with time in the modeled world.</li>
<li>If <span class="math inline">x</span> is a function of time <span class="math inline">x(t)</span>, we can think of the identity <span class="math inline">x</span> as a history of values (and these don’t change).</li>
<li>With time measured in discrete steps, we can model a time function as a sequence of values.</li>
<li>Stream processing allows us to model state without assignments.</li>
</ul>
<h2 id="3.5.1" class="anchor">
<a class="anchor__link link" href="#3.5.1">#</a><small class="number">3.5.1</small>Streams Are Delayed Lists
</h3>
<ul>
<li>If we represent streams as lists, we get elegance at the price of severe inefficiency (time <em>and</em> space).</li>
<li>Consider adding all the primes in an interval. Using <code>filter</code> and <code>reduce</code>, we waste a lot of space storing lists.</li>
<li>Streams are lazy lists. They are the clever idea of using sequence manipulations without incurring the cost.</li>
<li>We only construct an item of the stream when it is needed.</li>
<li>We have <code>cons-stream</code>, <code>stream-car</code>, <code>stream-cdr</code>, <code>the-empty-stream</code>, and <code>stream-null?</code>.</li>
<li>The <code>cons-stream</code> procedure must not evaluate its second argument until it is accessed by <code>stream-cdr</code>.</li>
<li>To implement streams, we will use <em>promises</em>. <code class="sourceCode scheme">(delay &lt;exp&gt;)</code> does not evaluate the argument but returns a promise. <code class="sourceCode scheme">(<span class="kw">force</span> &lt;promise&gt;)</code> evaluates a promise and returns the value.</li>
<li><code class="sourceCode scheme">(cons-stream a b)</code> is a special form equivalent to <code class="sourceCode scheme">(<span class="kw">cons</span> a (delay b))</code>.</li>
</ul>
<h3 id="3.5.1.1" class="anchor">
<a class="anchor__link link" href="#3.5.1.1">#</a>The stream implementation in action
</h3>
<blockquote>
<p>In general, we can think of delayed evaluation as “demand-driven” programming, we herby each stage in the stream process is activated only enough to satisfy the next stage. (438) FOO</p>
</blockquote>
<h3 id="3.5.1.2" class="anchor">
<a class="anchor__link link" href="#3.5.1.2">#</a>Implementing <code>delay</code> and <code>force</code>
</h3>
<ul>
<li>Promises are quite straightforward to implement.</li>
<li><code class="sourceCode scheme">(delay &lt;exp&gt;)</code> is syntactic sugar for <code class="sourceCode scheme">(<span class="kw">lambda</span> () &lt;exp&gt;)</code>.</li>
<li><code>force</code> simply calls the procedure. We can optimize it by saving the result and not calling the procedure a second time.</li>
<li>The promise stored in the <code>cdr</code> of the stream is also known as a <em>thunk</em>.</li>
</ul>
<h2 id="3.5.2" class="anchor">
<a class="anchor__link link" href="#3.5.2">#</a><small class="number">3.5.2</small>Infinite Streams
</h3>
<ul>
<li>With lazy sequences, we can manipulate infinitely long streams!</li>
<li>We can define Fibonacci sequence explicitly with a generator:</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(fibgen a b) (cons-stream a (fibgen b (<span class="op">+</span> a b))))</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> fibs </span>(fibgen <span class="dv">0</span> <span class="dv">1</span>))</span></code></pre></div>
<ul>
<li>As long as we don’t try to display the whole sequence, we will never get stuck in an infinite loop.</li>
<li>We can also create an infinite stream of primes.</li>
</ul>
<h3 id="3.5.2.1" class="anchor">
<a class="anchor__link link" href="#3.5.2.1">#</a>Defining streams implicitly
</h3>
<ul>
<li>Instead of using a generator procedure, we can define infinite streams implicitly, taking advantage of the laziness.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> fibs</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  (cons-stream</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>   <span class="dv">0</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>   (cons-stream <span class="dv">1</span> (stream-map <span class="op">+</span> fibs (stream-cdr fibs)))))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> pot</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  (cons-stream <span class="dv">1</span> (stream-map (<span class="kw">lambda</span> (x) (<span class="op">*</span> x <span class="dv">2</span>)) pot)))</span></code></pre></div>
<ul>
<li>This implicit technique is known as <em>corecursion</em>. Recursion works backward towards a base case, but corecursion works from the base and creates more data in terms of itself.</li>
</ul>
<h2 id="3.5.3" class="anchor">
<a class="anchor__link link" href="#3.5.3">#</a><small class="number">3.5.3</small>Exploiting the Stream Paradigm
</h3>
<ul>
<li>Streams can provide many of the benefits of local state and assignment while avoiding some of the theoretical tangles.</li>
<li>Using streams allows us to have different module boundaries.</li>
<li>We can focus on the whole stream/series/signal rather than on individual values.</li>
</ul>
<h3 id="3.5.3.1" class="anchor">
<a class="anchor__link link" href="#3.5.3.1">#</a>Formulating iterations as stream processes
</h3>
<ul>
<li>Before, we made iterative processes by updating state variables in recursive calls.</li>
<li>To compute the square root, we improved a guess until the values didn’t change very much.</li>
<li>We can make a stream that converges on the square root of <code>x</code>, and a stream to approximate <span class="math inline">π</span>.</li>
<li>One neat thing we can do with these streams is use sequence accelerators, such as Euler’s transform.</li>
</ul>
<h3 id="3.5.3.2" class="anchor">
<a class="anchor__link link" href="#3.5.3.2">#</a>Infinite streams of pairs
</h3>
<ul>
<li>Previously, we handled traditional nested loops as processes defined on sequences of pairs.</li>
<li>We can find all pairs <span class="math inline">(i,j)</span> with <span class="math inline">i ≤ j</span> such that <span class="math inline">i + j</span> is prime like this:</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>(stream-filter</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a> (<span class="kw">lambda</span> (pair) (prime? (<span class="op">+</span> (<span class="kw">car</span> pair) (<span class="kw">cadr</span> pair))))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a> int-pairs)</span></code></pre></div>
<ul>
<li>We need some way of producing a stream of all integer pairs.</li>
<li>More generally, we can combined two streams to get a two-dimensional grid of pairs, and we want to reduce this to a one-dimensional stream.</li>
<li>One way to do this is to use <code>interleave</code> in the recursive definition, in order to handle infinite streams.</li>
</ul>
<h3 id="3.5.3.3" class="anchor">
<a class="anchor__link link" href="#3.5.3.3">#</a>Streams as signals
</h3>
<ul>
<li>We can use streams to model signal-processing systems.</li>
<li>For example, taking the integral of a signal:</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(integral integrand initial-value dt)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> int</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    (cons-stream initial-value</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                 (add-streams (scale-stream integrand dt)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                              int)))</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  int)</span></code></pre></div>
<h2 id="3.5.4" class="anchor">
<a class="anchor__link link" href="#3.5.4">#</a><small class="number">3.5.4</small>Streams and Delayed Evaluation
</h3>
<ul>
<li>The use of <code>delay</code> in <code>cons-stream</code> is crucial to defining streams with feedback loops.</li>
<li>However, there are cases where we need further, explicit uses of <code>delay</code>.</li>
<li>For example, solving the differential equation <span class="math inline">dy/dt = f(y)</span> where <span class="math inline">f</span> is a given function.</li>
<li>The problem here is that <code>y</code> and <code>dy</code> will depend on each other.</li>
<li>To solve this, we need to change <code>integral</code> to take a delayed integrand.</li>
</ul>
<h3 id="3.5.4.1" class="anchor">
<a class="anchor__link link" href="#3.5.4.1">#</a>Normal-order evaluation
</h3>
<ul>
<li>Explicit use of <code>delay</code> and <code>force</code> is powerful, but makes our programs more complex.</li>
<li>It creates two classes of procedures: normal, and ones that take delayed arguments.</li>
<li>(This is similar to the sync vs. async divide in modern programming languages.)</li>
<li>This forces us to define separate classes of higher-order procedures, unless we make everything delayed, equivalent to normal-order evaluation (like Haskell).</li>
<li>Mutability and delayed evaluation do not mix well.</li>
</ul>
<h2 id="3.5.5" class="anchor">
<a class="anchor__link link" href="#3.5.5">#</a><small class="number">3.5.5</small>Modularity of Functional Programs and Modularity of Objects
</h3>
<ul>
<li>Modularity through encapsulation is a major benefit of introducing assignment.</li>
<li>Stream models can provide equivalent modularity without assignment.</li>
<li>For example, we can reimplement the Monte Carlo simulation with streams.</li>
</ul>
<h3 id="3.5.5.1" class="anchor">
<a class="anchor__link link" href="#3.5.5.1">#</a>A functional-programming view of time
</h3>
<ul>
<li>Streams represent time explicitly, decoupling the simulated world from evaluation.</li>
<li>They produce stateful-seeming behavior but avoid all the thorny issues of state.</li>
<li>However, the issues come back when we need to merge streams together.</li>
<li>Immutability is a key pillar of <em>functional programming languages</em>.</li>
</ul>
<blockquote>
<p>We can model the world as a collection of separate, time-bound, interacting objects with state, or we can model the world as a single, timeless, stateless unity. Each view has powerful advantages, but neither view alone is completely satisfactory. A grand unification has yet to emerge. (486) FOO</p>
</blockquote>
<blockquote>
<p>The object model approximates the world by dividing it into separate pieces. The functional model does not modularize along object boundaries. The object model is useful when the unshared state of the “objects” is much larger than the state that they share. (486) FOO</p>
</blockquote>
<nav class="pagenav pagenav--bottom">
  <div class="pagenav__item pagenav__item--prev">
    <a class="pagenav__link link" href="4.html">
      <svg class="arrow" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <line x1="5" y1="12" x2="19" y2="12"/>
  <line x1="5" y1="12" x2="11" y2="18"/>
  <line x1="5" y1="12" x2="11" y2="6"/>
</svg>&nbsp;Prev
    </a>
  </div>
  <div class="pagenav__item pagenav__item--up">
    <a class="pagenav__link link" href="index.html"><svg class="arrow" width="18" height="18" viewBox="0 0 24 24" stroke-width="1.75" stroke="currentColor" fill="none">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <line x1="12" y1="5" x2="12" y2="19"/>
  <line x1="18" y1="11" x2="12" y2="5"/>
  <line x1="6" y1="11" x2="12" y2="5"/>
</svg>&nbsp;Up</a>
  </div>
  <div class="pagenav__item pagenav__item--next">
    <a class="pagenav__link link" href="../4/index.html">
      Next&nbsp;<svg class="arrow" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <line x1="5" y1="12" x2="19" y2="12"/>
  <line x1="13" y1="18" x2="19" y2="12"/>
  <line x1="13" y1="6" x2="19" y2="12"/>
</svg>
    </a>
  </div>
</nav>
<footer class="footer">
  © 2020 Mitchell Kember
</footer>
</body>
</html>
