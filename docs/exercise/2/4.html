<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SICP Section 2.4 Exercises</title>
  <link rel="stylesheet" href="../../style.css">
</head>
<body>
<div hidden>
  <svg>
    <symbol id="up" viewBox="0 0 11 12">
      <path fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M5.5.8v10.4m4.457-5.943L5.5.8 1.043 5.257"/>
    </symbol>
    <symbol id="left" viewBox="0 0 12 11">
      <path fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M.8 5.5h10.4M5.257 9.957L.8 5.5l4.457-4.457"/>
    </symbol>
    <symbol id="right" viewBox="0 0 12 11">
      <use xlink:href="#left" transform="matrix(-1 0 0 1 12 0)"/>
    </symbol>
    <symbol id="external" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" d="M10.688 5.438H4.125A2.65 2.65 0 001.5 8.063v11.812A2.65 2.65 0 004.125 22.5h11.813a2.65 2.65 0 002.624-2.625v-6.563m-9.187 1.313L22.5 1.5m-6.563 0H22.5v6.563"/>
    </symbol>
  </svg>
</div>
<a class="skip-link" href="#main">Skip to main content</a>
<header class="header">
  <a class="title link" href="../../index.html">SICP Study</a>
  <nav class="sitenav" aria-label="site">
    <a class="sitenav__item link"
        href="../../text/index.html" aria-label="textbook notes">Text</a>
    <a class="sitenav__item link"
        href="../../lecture/index.html" aria-label="lecture notes">Lecture</a>
    <a class="sitenav__item sitenav__item--active link"
        href="../../exercise/index.html" aria-label="exercises">Exercise</a>
    <a class="sitenav__item sitenav__item--last link"
        href="https://github.com/mk12/sicp" aria-label="GitHub repository">
      Source
      <svg class="github-mark" width="25" height="25" viewBox="0 0 136 133" aria-hidden="true">
        <path fill="currentColor" d="M67.866.002C30.387.002 0 30.39 0 67.877c0 29.988 19.446 55.425 46.417 64.404 3.396.621 4.633-1.475 4.633-3.275 0-1.608-.058-5.879-.091-11.541-18.88 4.1-22.863-9.1-22.863-9.1-3.087-7.838-7.537-9.925-7.537-9.925-6.163-4.213.466-4.13.466-4.13 6.813.484 10.396 6.996 10.396 6.996 6.054 10.371 15.888 7.375 19.754 5.642.617-4.387 2.367-7.38 4.309-9.075-15.071-1.712-30.917-7.537-30.917-33.546 0-7.408 2.646-13.466 6.988-18.212-.7-1.717-3.03-8.617.662-17.963 0 0 5.7-1.825 18.667 6.959 5.412-1.505 11.22-2.259 16.992-2.284 5.762.025 11.57.78 16.991 2.284 12.959-8.784 18.646-6.959 18.646-6.959 3.704 9.346 1.375 16.246.675 17.963 4.35 4.746 6.98 10.804 6.98 18.212 0 26.075-15.872 31.813-30.992 33.492 2.437 2.096 4.608 6.237 4.608 12.57 0 9.072-.083 16.392-.083 18.617 0 1.817 1.22 3.93 4.666 3.267 26.95-8.996 46.38-34.417 46.38-64.396 0-37.487-30.392-67.875-67.88-67.875"/>
      </svg>      
    </a>
  </nav>
</header>
<nav class="pagenav pagenav--top" aria-label="page">
  <div class="pagenav__item pagenav__item--left">
    <a class="pagenav__link link" href="3.html" aria-label="previous page">
      <svg width="12" height="11" aria-hidden="true"><use xlink:href="#left"/>
      </svg><span class="pagenav__prev">Prev</span>
    </a>
  </div>
  <div class="pagenav__item pagenav__item--center">
    <a class="pagenav__link link" href="index.html" aria-label="parent page">
      <svg width="11" height="12" aria-hidden="true"><use xlink:href="#up"/>
      </svg><span class="pagenav__up">Up</span>
    </a>
  </div>
  <div class="pagenav__item pagenav__item--right">
    <a class="pagenav__link link" href="5.html" aria-label="next page">
      <span class="pagenav__next">Next</span
        ><svg width="12" height="11" aria-hidden="true"
        ><use xlink:href="#right"/></svg>
    </a>
  </div>
</nav>
<main id="main">
<h1 id="2.4" class="anchor">
<a class="anchor__link link" href="#2.4" aria-hidden="true">#</a> <span class="number">2.4</span> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-17.html">Multiple Representations for Abstract Data<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h1>
<h2 id="2.4.1" class="anchor">
<a class="anchor__link link" href="#2.4.1" aria-hidden="true">#</a> <span class="number">2.4.1</span> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-17.html#%25_sec_2.4.1">Representations for Complex Numbers<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h2>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="../1/1.html#1.1.4">1.1.4</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>square</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="codeblock">(<span class="kw">define</span> (add-complex z1 z2)
  (make-from-real-imag
   (<span class="fu">+</span> (real-part z1) (real-part z2))
   (<span class="fu">+</span> (imag-part z1) (imag-part z2))))
(<span class="kw">define</span> (sub-complex z1 z2)
  (make-from-real-imag
   (<span class="fu">-</span> (real-part z1) (real-part z2))
   (<span class="fu">-</span> (imag-part z1) (imag-part z2))))
(<span class="kw">define</span> (mul-complex z1 z2)
  (make-from-mag-ang
   (<span class="fu">*</span> (magnitude z1) (magnitude z2))
   (<span class="fu">+</span> (angle z1) (angle z2))))
(<span class="kw">define</span> (div-complex z1 z2)
  (make-from-mag-ang
   (<span class="fu">/</span> (magnitude z1) (magnitude z2))
   (<span class="fu">-</span> (angle z1) (angle z2))))</code></pre>
<p>Ben’s representation (rectangular form):</p>
<pre><code class="codeblock">(<span class="kw">define</span> real-part <span class="fu">car</span>)
(<span class="kw">define</span> imag-part <span class="fu">cdr</span>)
(<span class="kw">define</span> (magnitude z)
  (<span class="fu">sqrt</span> (<span class="fu">+</span> (square (real-part z))
           (square (imag-part z)))))
(<span class="kw">define</span> (angle z)
  (<span class="fu">atan</span> (imag-part z) (real-part z)))
(<span class="kw">define</span> make-from-real-imag <span class="fu">cons</span>)
(<span class="kw">define</span> (make-from-mag-ang r a)
  (<span class="fu">cons</span> (<span class="fu">*</span> r (<span class="fu">cos</span> a)) (<span class="fu">*</span> r (<span class="fu">sin</span> a))))</code></pre>
<p>Rectangular form can give exact answers for addition and subtraction.</p>
<pre><code class="codeblock">(<span class="kw">define</span> z1 (add-complex (make-from-real-imag <span class="cn">1 2</span>) (make-from-real-imag <span class="cn">3 4</span>)))
(<span class="kw">define</span> z2 (mul-complex (make-from-mag-ang <span class="cn">5 1</span>) (make-from-mag-ang <span class="cn">6 2</span>)))
(real-part z1) <span class="op">=&gt;</span> <span class="cn">4</span>
(imag-part z1) <span class="op">=&gt;</span> <span class="cn">6</span>
(magnitude z2) <span class="op">~&gt;</span> <span class="cn">30</span>
(angle z2) <span class="op">~&gt;</span> <span class="cn">3</span></code></pre>
<p>Alyssa’s representation (polar form):</p>
<pre><code class="codeblock">(<span class="kw">define</span> (real-part z) (<span class="fu">*</span> (magnitude z) (<span class="fu">cos</span> (angle z))))
(<span class="kw">define</span> (imag-part z) (<span class="fu">*</span> (magnitude z) (<span class="fu">sin</span> (angle z))))
(<span class="kw">define</span> magnitude <span class="fu">car</span>)
(<span class="kw">define</span> angle <span class="fu">cdr</span>)
(<span class="kw">define</span> (make-from-real-imag x y)
  (<span class="fu">cons</span> (<span class="fu">sqrt</span> (<span class="fu">+</span> (square x) (square y)))
        (<span class="fu">atan</span> y x)))
(<span class="kw">define</span> make-from-mag-ang <span class="fu">cons</span>)</code></pre>
<p>Polar form can give exact answers for multiplication and division.</p>
<pre><code class="codeblock">(<span class="kw">define</span> z1 (add-complex (make-from-real-imag <span class="cn">1 2</span>) (make-from-real-imag <span class="cn">3 4</span>)))
(<span class="kw">define</span> z2 (mul-complex (make-from-mag-ang <span class="cn">5 1</span>) (make-from-mag-ang <span class="cn">6 2</span>)))
(real-part z1) <span class="op">~&gt;</span> <span class="cn">4</span>
(imag-part z1) <span class="op">~&gt;</span> <span class="cn">6</span>
(magnitude z2) <span class="op">=&gt;</span> <span class="cn">30</span>
(angle z2) <span class="op">=&gt;</span> <span class="cn">3</span></code></pre>
<h2 id="2.4.2" class="anchor">
<a class="anchor__link link" href="#2.4.2" aria-hidden="true">#</a> <span class="number">2.4.2</span> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-17.html#%25_sec_2.4.2">Tagged Data<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h2>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="../1/1.html#1.1.4">1.1.4</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>square</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="codeblock">(<span class="kw">define</span> (attach-tag type-tag contents)
  (<span class="fu">cons</span> type-tag contents))
(<span class="kw">define</span> (type-tag datum)
  (<span class="kw">if</span> (<span class="fu">pair?</span> datum)
      (<span class="fu">car</span> datum)
      (<span class="fu">error</span> <span class="qu">'type-tag</span> <span class="cn">"bad tagged datum"</span> datum)))
(<span class="kw">define</span> (contents datum)
  (<span class="kw">if</span> (<span class="fu">pair?</span> datum)
      (<span class="fu">cdr</span> datum)
      (<span class="fu">error</span> <span class="qu">'contents</span> <span class="cn">"bad tagged datum"</span> datum)))
(<span class="kw">define</span> (rectangular? z) (<span class="fu">eq?</span> (type-tag z) <span class="qu">'rectangular</span>))
(<span class="kw">define</span> (polar? z) (<span class="fu">eq?</span> (type-tag z) <span class="qu">'polar</span>))</code></pre>
<p>Ben’s representation (rectangular form):</p>
<pre><code class="codeblock">(<span class="kw">define</span> real-part-rectangular <span class="fu">car</span>)
(<span class="kw">define</span> imag-part-rectangular <span class="fu">cdr</span>)
(<span class="kw">define</span> (magnitude-rectangular z)
  (<span class="fu">sqrt</span> (<span class="fu">+</span> (square (real-part-rectangular z))
           (square (imag-part-rectangular z)))))
(<span class="kw">define</span> (angle-rectangular z)
  (<span class="fu">atan</span> (imag-part-rectangular z)
        (real-part-rectangular z)))
(<span class="kw">define</span> (make-from-real-imag-rectangular x y)
  (attach-tag <span class="qu">'rectangular</span> (<span class="fu">cons</span> x y)))
(<span class="kw">define</span> (make-from-mag-ang-rectangular r a)
  (attach-tag <span class="qu">'rectangular</span>
              (<span class="fu">cons</span> (<span class="fu">*</span> r (<span class="fu">cos</span> a))
                    (<span class="fu">*</span> r (<span class="fu">sin</span> a)))))</code></pre>
<p>Alyssa’s representation (polar form):</p>
<pre><code class="codeblock">(<span class="kw">define</span> (real-part-polar z)
  (<span class="fu">*</span> (magnitude-polar z) (<span class="fu">cos</span> (angle-polar z))))
(<span class="kw">define</span> (imag-part-polar z)
  (<span class="fu">*</span> (magnitude-polar z) (<span class="fu">sin</span> (angle-polar z))))
(<span class="kw">define</span> magnitude-polar <span class="fu">car</span>)
(<span class="kw">define</span> angle-polar <span class="fu">cdr</span>)
(<span class="kw">define</span> (make-from-real-imag-polar x y)
  (attach-tag <span class="qu">'polar</span>
              (<span class="fu">cons</span> (<span class="fu">sqrt</span> (<span class="fu">+</span> (square x) (square y)))
                    (<span class="fu">atan</span> y x))))
(<span class="kw">define</span> (make-from-mag-ang-polar r a)
  (attach-tag <span class="qu">'polar</span> (<span class="fu">cons</span> r a)))</code></pre>
<p>Generic selectors:</p>
<pre><code class="codeblock">(<span class="kw">define</span> (real-part z)
  (<span class="kw">cond</span> ((rectangular? z)
         (real-part-rectangular (contents z)))
        ((polar? z)
         (real-part-polar (contents z)))
        (<span class="kw">else</span> (<span class="fu">error</span> <span class="qu">'real-part</span> <span class="cn">"unknown type"</span> z))))
(<span class="kw">define</span> (imag-part z)
  (<span class="kw">cond</span> ((rectangular? z)
         (imag-part-rectangular (contents z)))
        ((polar? z)
         (imag-part-polar (contents z)))
        (<span class="kw">else</span> (<span class="fu">error</span> <span class="qu">'imag-part</span> <span class="cn">"unknown type"</span> z))))
(<span class="kw">define</span> (magnitude z)
  (<span class="kw">cond</span> ((rectangular? z)
         (magnitude-rectangular (contents z)))
        ((polar? z)
         (magnitude-polar (contents z)))
        (<span class="kw">else</span> (<span class="fu">error</span> <span class="qu">'magnitude</span> <span class="cn">"unknown type"</span> z))))
(<span class="kw">define</span> (angle z)
  (<span class="kw">cond</span> ((rectangular? z)
         (angle-rectangular (contents z)))
        ((polar? z)
         (angle-polar (contents z)))
        (<span class="kw">else</span> (<span class="fu">error</span> <span class="qu">'angle</span> <span class="cn">"unknown type"</span> z))))</code></pre>
<p>Generic constructors:</p>
<pre><code class="codeblock">(<span class="kw">define</span> make-from-real-imag make-from-real-imag-rectangular)
(<span class="kw">define</span> make-from-mag-ang make-from-mag-ang-polar)</code></pre>
<p>Generic operations:</p>
<pre><code class="codeblock">(<span class="kw">paste</span> (<a href="#2.4.1">:2.4.1</a> add-complex div-complex mul-complex sub-complex))</code></pre>
<p>Now we can get exact answers for all operations:</p>
<pre><code class="codeblock">(<span class="kw">define</span> z1 (add-complex (make-from-real-imag <span class="cn">1 2</span>) (make-from-real-imag <span class="cn">3 4</span>)))
(<span class="kw">define</span> z2 (mul-complex (make-from-mag-ang <span class="cn">5 1</span>) (make-from-mag-ang <span class="cn">6 2</span>)))
z1 <span class="op">=&gt;</span> (make-from-real-imag <span class="cn">4 6</span>)
z2 <span class="op">=&gt;</span> (make-from-mag-ang <span class="cn">30 3</span>)</code></pre>
<h2 id="2.4.3" class="anchor">
<a class="anchor__link link" href="#2.4.3" aria-hidden="true">#</a> <span class="number">2.4.3</span> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-17.html#%25_sec_2.4.3">Data-Directed Programming and Additivity<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h2>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="../1/1.html#1.1.4">1.1.4</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>square</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#2.4.2">2.4.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>attach-tag</code>
</li>
<li class="flat__item nowrap">
<code>contents</code>
</li>
<li class="flat__item nowrap">
<code>type-tag</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="../3/3.html#3.3.3.3">3.3.3.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>get</code>
</li>
<li class="flat__item nowrap">
<code>put</code>
</li>
<li class="flat__item nowrap">
<code>reset</code>
</li>
</ul>
</li>
</ul>
</aside>
<p>The textbook calls these procedures <code>install-rectangular-package</code> and <code>install-polar-package</code>. I shorten them to <code>rectangular-pkg</code> and <code>polar-pkg</code> since there are many of these procedures and the long names tend to bloat import lists.</p>
<pre><code class="codeblock">(<span class="kw">define</span> (rectangular-pkg)
  <span class="at">;; Internal procedures</span>
  (<span class="kw">define</span> real-part <span class="fu">car</span>)
  (<span class="kw">define</span> imag-part <span class="fu">cdr</span>)
  (<span class="kw">define</span> make-from-real-imag <span class="fu">cons</span>)
  (<span class="kw">define</span> (magnitude z)
    (<span class="fu">sqrt</span> (<span class="fu">+</span> (square (real-part z))
             (square (imag-part z)))))
  (<span class="kw">define</span> (angle z)
    (<span class="fu">atan</span> (imag-part z) (real-part z)))
  (<span class="kw">define</span> (make-from-mag-ang r a)
    (<span class="fu">cons</span> (<span class="fu">*</span> r (<span class="fu">cos</span> a)) (<span class="fu">*</span> r (<span class="fu">sin</span> a))))

  <span class="at">;; Interface to the rest of the system</span>
  (<span class="kw">define</span> (tag x) (attach-tag <span class="qu">'rectangular</span> x))
  (put <span class="qu">'real-part '(rectangular)</span> real-part)
  (put <span class="qu">'imag-part '(rectangular)</span> imag-part)
  (put <span class="qu">'magnitude '(rectangular)</span> magnitude)
  (put <span class="qu">'angle '(rectangular)</span> angle)
  (put <span class="qu">'make-from-real-imag 'rectangular</span>
       (<span class="kw">lambda</span> (x y) (tag (make-from-real-imag x y))))
  (put <span class="qu">'make-from-mag-ang 'rectangular</span>
       (<span class="kw">lambda</span> (r a) (tag (make-from-mag-ang r a)))))

(<span class="kw">define</span> (polar-pkg)
  <span class="at">;; Internal procedures</span>
  (<span class="kw">define</span> magnitude <span class="fu">car</span>)
  (<span class="kw">define</span> angle <span class="fu">cdr</span>)
  (<span class="kw">define</span> make-from-mag-ang <span class="fu">cons</span>)
  (<span class="kw">define</span> (real-part z)
    (<span class="fu">*</span> (magnitude z) (<span class="fu">cos</span> (angle z))))
  (<span class="kw">define</span> (imag-part z)
    (<span class="fu">*</span> (magnitude z) (<span class="fu">sin</span> (angle z))))
  (<span class="kw">define</span> (make-from-real-imag x y)
    (<span class="fu">cons</span> (<span class="fu">sqrt</span> (<span class="fu">+</span> (square x) (square y)))
          (<span class="fu">atan</span> y x)))

  <span class="at">;; Interface to the rest of the system</span>
  (<span class="kw">define</span> (tag x) (attach-tag <span class="qu">'polar</span> x))
  (put <span class="qu">'real-part '(polar)</span> real-part)
  (put <span class="qu">'imag-part '(polar)</span> imag-part)
  (put <span class="qu">'magnitude '(polar)</span> magnitude)
  (put <span class="qu">'angle '(polar)</span> angle)
  (put <span class="qu">'make-from-real-imag 'polar</span>
       (<span class="kw">lambda</span> (x y) (tag (make-from-real-imag x y))))
  (put <span class="qu">'make-from-mag-ang 'polar</span>
       (<span class="kw">lambda</span> (r a) (tag (make-from-mag-ang r a)))))</code></pre>
<p>Helpers to apply generic operations:</p>
<pre><code class="codeblock">(<span class="kw">define</span> (apply-generic op . args)
  (<span class="kw">let*</span> ((type-tags (<span class="fu">map</span> type-tag args))
         (proc (get op type-tags)))
    (<span class="kw">if</span> proc
        (<span class="fu">apply</span> proc (<span class="fu">map</span> contents args))
        (<span class="fu">error</span> <span class="qu">'apply-generic</span> <span class="cn">"no method for argument types"</span> op type-tags))))

(<span class="kw">define</span> (apply-specific op type . args)
  (<span class="kw">let</span> ((proc (get op type)))
    (<span class="kw">if</span> proc
        (<span class="fu">apply</span> proc args)
        (<span class="fu">error</span> op <span class="cn">"no method for type"</span> op type))))</code></pre>
<p>Generic selectors:</p>
<pre><code class="codeblock">(<span class="kw">define</span> (real-part z) (apply-generic <span class="qu">'real-part</span> z))
(<span class="kw">define</span> (imag-part z) (apply-generic <span class="qu">'imag-part</span> z))
(<span class="kw">define</span> (magnitude z) (apply-generic <span class="qu">'magnitude</span> z))
(<span class="kw">define</span> (angle z) (apply-generic <span class="qu">'angle</span> z))</code></pre>
<p>Generic constructors:</p>
<pre><code class="codeblock">(<span class="kw">define</span> (make-from-real-imag x y)
  (apply-specific <span class="qu">'make-from-real-imag 'rectangular</span> x y))
(<span class="kw">define</span> (make-from-mag-ang r a)
  (apply-specific <span class="qu">'make-from-mag-ang 'polar</span> r a))</code></pre>
<p>Generic operations:</p>
<pre><code class="codeblock">(<span class="kw">paste</span> (<a href="#2.4.1">:2.4.1</a> add-complex div-complex mul-complex sub-complex))</code></pre>
<p>Helper procedure to run installers with a clean slate:</p>
<pre><code class="codeblock">(<span class="kw">define</span> (using . installers)
  (reset)
  (<span class="fu">for-each</span> (<span class="kw">lambda</span> (f) (f)) installers))</code></pre>
<p>Putting it all together:</p>
<pre><code class="codeblock">(using rectangular-pkg polar-pkg)

(<span class="kw">define</span> z1 (add-complex (make-from-real-imag <span class="cn">1 2</span>) (make-from-real-imag <span class="cn">3 4</span>)))
(<span class="kw">define</span> z2 (mul-complex (make-from-mag-ang <span class="cn">5 1</span>) (make-from-mag-ang <span class="cn">6 2</span>)))
z1 <span class="op">=&gt;</span> (make-from-real-imag <span class="cn">4 6</span>)
z2 <span class="op">=&gt;</span> (make-from-mag-ang <span class="cn">30 3</span>)</code></pre>
<h3 id="ex2.73" class="anchor">
<a class="anchor__link link" href="#ex2.73" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-17.html#%25_thm_2.73">Exercise 2.73<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="2.html#2.2.3.1">2.2.3.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>accumulate</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="3.html#2.3.2">2.3.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>make-product</code>
</li>
<li class="flat__item nowrap">
<code>make-sum</code>
</li>
<li class="flat__item nowrap">
<code>same-variable?</code>
</li>
<li class="flat__item nowrap">
<code>variable?</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#2.4.3">2.4.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>apply-specific</code>
</li>
<li class="flat__item nowrap">
<code>using</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="../3/3.html#3.3.3.3">3.3.3.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>put</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="3.html#ex2.56">Ex 2.56</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>make-exponentiation</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="codeblock">(<span class="kw">define</span> (deriv expr var)
  (<span class="kw">cond</span> ((<span class="fu">number?</span> expr) <span class="cn">0</span>)
        ((variable? expr) (<span class="kw">if</span> (same-variable? expr var) <span class="cn">1 0</span>))
        (<span class="kw">else</span> (apply-specific <span class="qu">'deriv</span> (operator expr) (operands expr) var))))
(<span class="kw">define</span> operator <span class="fu">car</span>)
(<span class="kw">define</span> operands <span class="fu">cdr</span>)</code></pre>
<ol type="a">
<li><p>We rewrote <code>deriv</code> to dispatch based on the operator of the expression. However, it still uses explicit case analysis for numbers and variables. We can’t assimilate those into the data-directed dispatch because they have nothing that can be used as a type tag. Scheme only provides predicates like <code>number?</code>, not a procedure like <code>(type expr)</code> that could return <code>'number</code>. We can write our own, but this just moves the case anaylsis somewhere else:</p>
<pre><code class="codeblock">(<span class="kw">define</span> (type expr)
  (<span class="kw">cond</span> ((<span class="fu">number?</span> expr) <span class="qu">'number</span>)
        ((variable? expr) <span class="qu">'variable</span>)
        (<span class="kw">else</span> (operator expr))))</code></pre></li>
<li><p>Packages for sum and product differentiation:</p>
<pre><code class="codeblock">(<span class="kw">define</span> (sum-pkg)
  (<span class="kw">define</span> (deriv-sum terms var)
    (accumulate make-sum <span class="cn">0</span> (<span class="fu">map</span> (<span class="kw">lambda</span> (t) (deriv t var)) terms)))
  (put <span class="qu">'deriv '+</span> deriv-sum))

(<span class="kw">define</span> (product-pkg)
  (<span class="kw">define</span> multiplier <span class="fu">car</span>)
  (<span class="kw">define</span> (multiplicand product)
    (accumulate make-product <span class="cn">1</span> (<span class="fu">cdr</span> product)))
  (<span class="kw">define</span> (deriv-product product var)
    (make-sum (make-product (multiplier product)
                            (deriv (multiplicand product) var))
              (make-product (deriv (multiplier product) var)
                            (multiplicand product))))
  (put <span class="qu">'deriv '*</span> deriv-product))</code></pre>
<p>Note that we can’t reuse the selectors <code>multiplier</code> and <code>multiplicand</code> from <a href="3.html#ex2.57">Exercise&nbsp;2.57</a> because they assume the list includes the operator.</p></li>
<li><p>Package for power differentiation:</p>
<pre><code class="codeblock">(<span class="kw">define</span> (power-pkg)
  (<span class="kw">define</span> base <span class="fu">car</span>)
  (<span class="kw">define</span> exponent <span class="fu">cadr</span>)
  (<span class="kw">define</span> (deriv-power power var)
    (make-product
     (make-product (exponent power)
                   (make-exponentiation
                    (base power)
                    (make-sum (exponent power) <span class="cn">-1</span>)))
     (deriv (base power) var)))
  (put <span class="qu">'deriv '**</span> deriv-power))</code></pre>
<p>Note that we can’t reuse the selectors <code>base</code> and <code>exponent</code> from <a href="3.html#ex2.56">Exercise&nbsp;2.56</a> because they assume the list includes the operator.</p></li>
<li><p>If we wanted to index the procedures in the opposite way, we would simply need to swap the first two arguments to <code>put</code> in all the package installation procedures.</p></li>
</ol>
<p>Let’s test the new system:</p>
<pre><code class="codeblock">(using sum-pkg product-pkg power-pkg)

(deriv <span class="qu">'(+ x 3) 'x</span>) <span class="op">=&gt;</span> <span class="cn">1</span>
(deriv <span class="qu">'(* x y) 'x</span>) <span class="op">=&gt;</span> <span class="qu">'y</span>
(deriv <span class="qu">'(* (* x y) (+ x 3)) 'x</span>) <span class="op">=&gt;</span> <span class="qu">'(+ (* x y) (* y (+ x 3)))</span>
(deriv <span class="qu">'(* 3 (** x 5)) 'x</span>) <span class="op">=&gt;</span> <span class="qu">'(* 3 (* 5 (** x 4)))</span></code></pre>
<h3 id="ex2.74" class="anchor">
<a class="anchor__link link" href="#ex2.74" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-17.html#%25_thm_2.74">Exercise 2.74<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#2.4.2">2.4.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>attach-tag</code>
</li>
<li class="flat__item nowrap">
<code>contents</code>
</li>
<li class="flat__item nowrap">
<code>type-tag</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#2.4.3">2.4.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>apply-specific</code>
</li>
<li class="flat__item nowrap">
<code>using</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="../3/3.html#3.3.3.3">3.3.3.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>put</code>
</li>
</ul>
</li>
</ul>
</aside>
<ol type="a">
<li><p>Each division should tag their file with a symbol such as <code>'marketing</code>, and install an implementation of <code>get-record</code> that deals with their internal record structure.</p>
<pre><code class="codeblock">(<span class="kw">define</span> (get-record file employee-name)
  (<span class="kw">let*</span> ((tag (type-tag file))
         (record
          (apply-specific <span class="qu">'get-record</span> tag (contents file) employee-name)))
    (<span class="kw">and</span> record (attach-tag tag record))))</code></pre></li>
<li><p>Since our generic <code>get-record</code> reattaches the division tag to the returned record, there is no need for divisions to tag records or do anything special. They just need to install an implementation of <code>get-salary</code>.</p>
<pre><code class="codeblock">(<span class="kw">define</span> (get-salary record)
  (apply-specific <span class="qu">'get-salary</span> (type-tag record) (contents record)))</code></pre></li>
<li><p>Procedure to find an employee’s record across all files:</p>
<pre><code class="codeblock">(<span class="kw">define</span> (find-employee-record employee-name files)
  (<span class="kw">if</span> (<span class="fu">null?</span> files)
      <span class="cn">#f</span>
      (<span class="kw">or</span> (get-record (<span class="fu">car</span> files) employee-name)
          (find-employee-record employee-name (<span class="fu">cdr</span> files)))))</code></pre></li>
<li><p>When they take over a new company, they must tag its file and install implementations of <code>get-record</code> and <code>get-salary</code> for it.</p></li>
</ol>
<p>Here is an example of a company with two divisions:</p>
<pre><code class="codeblock">(<span class="kw">define</span> files
  (<span class="fu">list</span> (attach-tag <span class="qu">'marketing
                    '("Alice" "Bob")</span>)
        (attach-tag <span class="qu">'sales
                    '(("Joe" 40) ("Jane" 60))</span>)))

(<span class="kw">define</span> (company-pkg)
  (<span class="kw">define</span> (get-record-marketing records name)
    (<span class="kw">cond</span> ((<span class="fu">null?</span> records) <span class="cn">#f</span>)
          ((<span class="fu">equal?</span> (<span class="fu">car</span> records) name) name)
          (<span class="kw">else</span> (get-record-marketing (<span class="fu">cdr</span> records) name))))
  (<span class="kw">define</span> (get-salary-marketing record) <span class="cn">50</span>)
  (<span class="kw">define</span> (get-record-sales records name)
    (<span class="kw">cond</span> ((<span class="fu">null?</span> records) <span class="cn">#f</span>)
          ((<span class="fu">equal?</span> (<span class="fu">caar</span> records) name) (<span class="fu">car</span> records))
          (<span class="kw">else</span> (get-record-sales (<span class="fu">cdr</span> records) name))))
  (<span class="kw">define</span> get-salary-sales <span class="fu">cadr</span>)
  (put <span class="qu">'get-record 'marketing</span> get-record-marketing)
  (put <span class="qu">'get-salary 'marketing</span> get-salary-marketing)
  (put <span class="qu">'get-record 'sales</span> get-record-sales)
  (put <span class="qu">'get-salary 'sales</span> get-salary-sales))

(using company-pkg)

(find-employee-record <span class="cn">"Nobody"</span> files) <span class="op">=&gt;</span> <span class="cn">#f</span>
(get-salary (find-employee-record <span class="cn">"Alice"</span> files)) <span class="op">=&gt;</span> <span class="cn">50</span>
(get-salary (find-employee-record <span class="cn">"Bob"</span> files)) <span class="op">=&gt;</span> <span class="cn">50</span>
(get-salary (find-employee-record <span class="cn">"Joe"</span> files)) <span class="op">=&gt;</span> <span class="cn">40</span>
(get-salary (find-employee-record <span class="cn">"Jane"</span> files)) <span class="op">=&gt;</span> <span class="cn">60</span></code></pre>
<h3 id="2.4.3.1" class="anchor">
<a class="anchor__link link" href="#2.4.3.1" aria-hidden="true">#</a> <span class="number">2.4.3.1</span> Message passing
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="../1/1.html#1.1.4">1.1.4</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>square</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="codeblock">(<span class="kw">define</span> (make-from-real-imag x y)
  (<span class="kw">lambda</span> (op)
    (<span class="kw">cond</span> ((<span class="fu">eq?</span> op <span class="qu">'real-part</span>) x)
          ((<span class="fu">eq?</span> op <span class="qu">'imag-part</span>) y)
          ((<span class="fu">eq?</span> op <span class="qu">'magnitude</span>) (<span class="fu">sqrt</span> (<span class="fu">+</span> (square x) (square y))))
          ((<span class="fu">eq?</span> op <span class="qu">'angle</span>) (<span class="fu">atan</span> y x))
          (<span class="kw">else</span> (<span class="fu">error</span> <span class="qu">'make-from-real-imag</span> <span class="cn">"unknown op"</span> op)))))

(<span class="kw">define</span> (apply-generic op arg) (arg op))

(apply-generic <span class="qu">'real-part</span> (make-from-real-imag <span class="cn">3 4</span>)) <span class="op">=&gt;</span> <span class="cn">3</span>
(apply-generic <span class="qu">'magnitude</span> (make-from-real-imag <span class="cn">0 1</span>)) <span class="op">~&gt;</span> <span class="cn">1</span></code></pre>
<h3 id="ex2.75" class="anchor">
<a class="anchor__link link" href="#ex2.75" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-17.html#%25_thm_2.75">Exercise 2.75<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#2.4.3.1">2.4.3.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>apply-generic</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="codeblock">(<span class="kw">define</span> (make-from-mag-ang r a)
  (<span class="kw">lambda</span> (op)
    (<span class="kw">cond</span> ((<span class="fu">eq?</span> op <span class="qu">'real-part</span>) (<span class="fu">*</span> r (<span class="fu">cos</span> a)))
          ((<span class="fu">eq?</span> op <span class="qu">'imag-part</span>) (<span class="fu">*</span> r (<span class="fu">sin</span> a)))
          ((<span class="fu">eq?</span> op <span class="qu">'magnitude</span>) r)
          ((<span class="fu">eq?</span> op <span class="qu">'angle</span>) a)
          (<span class="kw">else</span> (<span class="fu">error</span> <span class="qu">'make-from-mag-ang</span> <span class="cn">"unknown op"</span> op)))))

(apply-generic <span class="qu">'magnitude</span> (make-from-mag-ang <span class="cn">15 0.5</span>)) <span class="op">=&gt;</span> <span class="cn">15</span>
(apply-generic <span class="qu">'imag-part</span> (make-from-mag-ang <span class="cn">1 0</span>)) <span class="op">~&gt;</span> <span class="cn">0</span></code></pre>
<h3 id="ex2.76" class="anchor">
<a class="anchor__link link" href="#ex2.76" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-17.html#%25_thm_2.76">Exercise 2.76<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<ul>
<li>Generic operations with explicit dispatch
<ul>
<li><em>New type</em>
<ul>
<li>Add a new clause to all generic procedures.</li>
</ul></li>
<li><em>New operation</em>
<ul>
<li>Write a generic procedure that handles all types.</li>
</ul></li>
</ul></li>
<li>Data-directed style
<ul>
<li><em>New type</em>
<ul>
<li>Install implementations of every operation.</li>
</ul></li>
<li><em>New operation</em>
<ul>
<li>Install implementations for every type.</li>
<li>Write a wrapper that invokes <code>apply-generic</code>.</li>
</ul></li>
</ul></li>
<li>Message-passing style
<ul>
<li><em>New type</em>
<ul>
<li>Write a procedure that handles all operations.</li>
</ul></li>
<li><em>New operation</em>
<ul>
<li>Add a new clause to the method dispatch of all types.</li>
</ul></li>
</ul></li>
</ul>
<p>All three styles allow adding new types and operations, but they are optimized for different use cases. Generic operations with explicit dispatch is best when mostly adding new operations, while message passing is best when mostly adding new types. In each case, you can implement the new functionality in a self-contained piece of code, whereas using the other system requires editing many disparate pieces of code.</p>
<p>The data-directed style is best when adding a mix of types and operations, since it works equally well for both. It can also be used all the time instead of the other two systems. Its main drawback is the complexity of global mutable state (discussed more in <a href="../3/index.html">Chapter&nbsp;3</a>) used for the table. Without knowing the contents of the table, you cannot be sure what will happen when invoking a generic procedure in the data-directed style.</p>
</main>
<nav class="pagenav pagenav--bottom" aria-label="page">
  <div class="pagenav__item pagenav__item--left">
    <a class="pagenav__link link" href="3.html" aria-label="previous page">
      <svg width="12" height="11" aria-hidden="true"><use xlink:href="#left"/>
      </svg><span class="pagenav__prev">Prev</span>
    </a>
  </div>
  <div class="pagenav__item pagenav__item--center">
    <a class="pagenav__link link" href="index.html" aria-label="parent page">
      <svg width="11" height="12" aria-hidden="true"><use xlink:href="#up"/>
      </svg><span class="pagenav__up">Up</span>
    </a>
  </div>
  <div class="pagenav__item pagenav__item--right">
    <a class="pagenav__link link" href="5.html" aria-label="next page">
      <span class="pagenav__next">Next</span
        ><svg width="12" height="11" aria-hidden="true"
        ><use xlink:href="#right"/></svg>
    </a>
  </div>
</nav>
<footer class="footer">
  <p>© 2022 Mitchell Kember</p>
</footer>
</body>
</html>
