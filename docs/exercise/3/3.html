<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SICP Section 3.3 Exercises</title>
  <link rel="stylesheet" href="../../style.css">
</head>
<body>
<div hidden>
  <svg>
    <symbol id="up" viewBox="0 0 11 12">
      <path fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M5.5.8v10.4m4.457-5.943L5.5.8 1.043 5.257"/>
    </symbol>
    <symbol id="left" viewBox="0 0 12 11">
      <path fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M.8 5.5h10.4M5.257 9.957L.8 5.5l4.457-4.457"/>
    </symbol>
    <symbol id="right" viewBox="0 0 12 11">
      <use xlink:href="#left" transform="matrix(-1 0 0 1 12 0)"/>
    </symbol>
    <symbol id="external" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" d="M10.688 5.438H4.125A2.65 2.65 0 001.5 8.063v11.812A2.65 2.65 0 004.125 22.5h11.813a2.65 2.65 0 002.624-2.625v-6.563m-9.187 1.313L22.5 1.5m-6.563 0H22.5v6.563"/>
    </symbol>
  </svg>
</div>
<a class="skip-link" href="#main">Skip to main content</a>
<header class="header">
  <a class="title link" href="../../index.html">SICP Study</a>
  <nav class="sitenav" aria-label="site">
    <a class="sitenav__item link"
        href="../../text/index.html" aria-label="textbook notes">Text</a>
    <a class="sitenav__item link"
        href="../../lecture/index.html" aria-label="lecture notes">Lecture</a>
    <a class="sitenav__item sitenav__item--active link"
        href="../../exercise/index.html" aria-label="exercises">Exercise</a>
    <a class="sitenav__item sitenav__item--last link"
        href="https://github.com/mk12/sicp" aria-label="GitHub repository">
      Source
      <svg class="github-mark" width="25" height="25" viewBox="0 0 136 133" aria-hidden="true">
        <path fill="currentColor" d="M67.866.002C30.387.002 0 30.39 0 67.877c0 29.988 19.446 55.425 46.417 64.404 3.396.621 4.633-1.475 4.633-3.275 0-1.608-.058-5.879-.091-11.541-18.88 4.1-22.863-9.1-22.863-9.1-3.087-7.838-7.537-9.925-7.537-9.925-6.163-4.213.466-4.13.466-4.13 6.813.484 10.396 6.996 10.396 6.996 6.054 10.371 15.888 7.375 19.754 5.642.617-4.387 2.367-7.38 4.309-9.075-15.071-1.712-30.917-7.537-30.917-33.546 0-7.408 2.646-13.466 6.988-18.212-.7-1.717-3.03-8.617.662-17.963 0 0 5.7-1.825 18.667 6.959 5.412-1.505 11.22-2.259 16.992-2.284 5.762.025 11.57.78 16.991 2.284 12.959-8.784 18.646-6.959 18.646-6.959 3.704 9.346 1.375 16.246.675 17.963 4.35 4.746 6.98 10.804 6.98 18.212 0 26.075-15.872 31.813-30.992 33.492 2.437 2.096 4.608 6.237 4.608 12.57 0 9.072-.083 16.392-.083 18.617 0 1.817 1.22 3.93 4.666 3.267 26.95-8.996 46.38-34.417 46.38-64.396 0-37.487-30.392-67.875-67.88-67.875"/>
      </svg>      
    </a>
  </nav>
</header>
<nav class="pagenav pagenav--top" aria-label="page">
  <div class="pagenav__item pagenav__item--left">
    <a class="pagenav__link link" href="2.html" aria-label="previous page">
      <svg width="12" height="11" aria-hidden="true"><use xlink:href="#left"/>
      </svg><span class="pagenav__prev">Prev</span>
    </a>
  </div>
  <div class="pagenav__item pagenav__item--center">
    <a class="pagenav__link link" href="index.html" aria-label="parent page">
      <svg width="11" height="12" aria-hidden="true"><use xlink:href="#up"/>
      </svg><span class="pagenav__up">Up</span>
    </a>
  </div>
  <div class="pagenav__item pagenav__item--right">
    <a class="pagenav__link link" href="4.html" aria-label="next page">
      <span class="pagenav__next">Next</span
        ><svg width="12" height="11" aria-hidden="true"
        ><use xlink:href="#right"/></svg>
    </a>
  </div>
</nav>
<main id="main">
<h1 id="3.3" class="anchor">
<a class="anchor__link link" href="#3.3" aria-hidden="true">#</a> <span class="number">3.3</span> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html">Modeling with Mutable Data<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h1>
<h2 id="3.3.1" class="anchor">
<a class="anchor__link link" href="#3.3.1" aria-hidden="true">#</a> <span class="number">3.3.1</span> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_sec_3.3.1">Mutable List Structure<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h2>
<pre><code class="blockcode">(<span class="kw">define</span> x)
(<span class="kw">define</span> y)</code></pre>
<p>Note: We must build new cons cells rather than quoting like <code><span class="vs">'((a b) c d)</span></code> because quoted forms are immutable and some Schemes enforce this.</p>
<pre><code class="blockcode">(<span class="kw">define</span> (reset!)
  (<span class="kw">set!</span> x (<span class="fu">list</span> (<span class="fu">list</span> <span class="vs">'a 'b</span>) <span class="vs">'c 'd</span>))
  (<span class="kw">set!</span> y (<span class="fu">list</span> <span class="vs">'e 'f</span>)))

(reset!)
(<span class="fu">set-car!</span> x y)
x <span class="op">=&gt;</span> (<span class="fu">cons</span> y (<span class="fu">cdr</span> x)) <span class="op">=&gt;</span> <span class="vs">'((e f) c d)</span>

(reset!)
(<span class="fu">set-cdr!</span> x y)
x <span class="op">=&gt;</span> (<span class="fu">cons</span> (<span class="fu">car</span> x) y) <span class="op">=&gt;</span> <span class="vs">'((a b) e f)</span></code></pre>
<h3 id="ex3.12" class="anchor">
<a class="anchor__link link" href="#ex3.12" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.12">Exercise 3.12<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<pre><code class="blockcode">(<span class="kw">define</span> (<span class="fu">append</span> x y)
  (<span class="kw">if</span> (<span class="fu">null?</span> x)
      y
      (<span class="fu">cons</span> (<span class="fu">car</span> x) (<span class="fu">append</span> (<span class="fu">cdr</span> x) y))))
(<span class="kw">define</span> (append! x y)
  (<span class="fu">set-cdr!</span> (last-pair x) y)
  x)
(<span class="kw">define</span> (last-pair x)
  (<span class="kw">if</span> (<span class="fu">null?</span> (<span class="fu">cdr</span> x)) x (last-pair (<span class="fu">cdr</span> x))))

(<span class="kw">define</span> x (<span class="fu">list</span> <span class="vs">'a 'b</span>))
(<span class="kw">define</span> y (<span class="fu">list</span> <span class="vs">'c 'd</span>))
(<span class="kw">define</span> z (<span class="fu">append</span> x y))

z <span class="op">=&gt;</span> <span class="vs">'(a b c d)</span>
(<span class="fu">cdr</span> x) <span class="op">=&gt;</span> <span class="vs">'(b)</span>
<span class="co">; x-&gt;[*|*]-&gt;[*|X]
;     |      |
;     V      V
;     a      b</span>

(<span class="kw">define</span> w (append! x y))
w <span class="op">=&gt;</span> <span class="vs">'(a b c d)</span>
(<span class="fu">cdr</span> x) <span class="op">=&gt;</span> <span class="vs">'(b c d)</span>
<span class="co">;                 y
;                 |
; x-&gt;[*|*]-&gt;[*|*]-&gt;[*|*]-&gt;[*|X]
; w/  |      |      |      |
;     V      V      V      V
;     a      b      c      d</span></code></pre>
<h3 id="ex3.13" class="anchor">
<a class="anchor__link link" href="#ex3.13" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.13">Exercise 3.13<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#ex3.12">Ex 3.12</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>last-pair</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (make-cycle x)
  (<span class="fu">set-cdr!</span> (last-pair x) x)
  x)

(<span class="kw">define</span> z (make-cycle (<span class="fu">list</span> <span class="vs">'a 'b 'c</span>)))
(<span class="fu">cadddr</span> z) <span class="op">=&gt;</span> <span class="vs">'a</span>
<span class="co">;    +-------------------+
;    V                   |
; z-&gt;[*|*]-&gt;[*|*]-&gt;[*|*]-+
;     |      |      |
;     V      V      V
;     a      b      c</span></code></pre>
<p>If we try to compute <code>(last-pair z)</code>, we will never finish because the list is not null-terminated and so <code>null?</code> will never be true. We will be stuck in an infinite recursion.</p>
<h3 id="ex3.14" class="anchor">
<a class="anchor__link link" href="#ex3.14" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.14">Exercise 3.14<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<pre><code class="blockcode">(<span class="kw">define</span> (mystery x)
  (<span class="kw">define</span> (loop x y)
    (<span class="kw">if</span> (<span class="fu">null?</span> x)
        y
        (<span class="kw">let</span> ((temp (<span class="fu">cdr</span> x)))
          (<span class="fu">set-cdr!</span> x y)
          (loop temp x))))
  (loop x <span class="vs">'()</span>))</code></pre>
<p>In general, <code>mystery</code> reverses the list <code>x</code>. It does this by walking through the list, setting the <code>cdr</code> of each pair to point to the previous pair instead of the next. For the very first pair, it sets the <code>cdr</code> to null.</p>
<pre><code class="blockcode">(<span class="kw">define</span> v (<span class="fu">list</span> <span class="vs">'a 'b 'c 'd</span>))
<span class="co">; v-&gt;[*|*]-&gt;[*|*]-&gt;[*|*]-&gt;[*|X]
;     |      |      |      |
;     V      V      V      V
;     a      b      c      d</span>

(<span class="kw">define</span> w (mystery v))
v <span class="op">=&gt;</span> <span class="vs">'(a)</span>
w <span class="op">=&gt;</span> <span class="vs">'(d c b a)</span>
<span class="co">; v-&gt;[*|X]&lt;-[*|*]&lt;-[*|*]&lt;-[*|*]&lt;-w
;     |      |      |      |
;     V      V      V      V
;     a      b      c      d</span></code></pre>
<p>These box-and-pointer diagrams make it obvious that <code>mystery</code> simply changes the directions of all the arrows.</p>
<h3 id="3.3.1.1" class="anchor">
<a class="anchor__link link" href="#3.3.1.1" aria-hidden="true">#</a> <span class="number">3.3.1.1</span> Sharing and identity
</h3>
<pre><code class="blockcode">(<span class="kw">define</span> x (<span class="fu">list</span> <span class="vs">'a 'b</span>))
(<span class="kw">define</span> z1 (<span class="fu">cons</span> x x))
(<span class="kw">define</span> z2 (<span class="fu">cons</span> (<span class="fu">list</span> <span class="vs">'a 'b</span>) (<span class="fu">list</span> <span class="vs">'a 'b</span>)))

(<span class="kw">define</span> (set-to-wow! x) (<span class="fu">set-car!</span> (<span class="fu">car</span> x) <span class="vs">'wow</span>) x)

z1 <span class="op">=&gt;</span> <span class="vs">'((a b) a b)</span>
(set-to-wow! z1) <span class="op">=&gt;</span> <span class="vs">'((wow b) wow b)</span>
z2 <span class="op">=&gt;</span> <span class="vs">'((a b) a b)</span>
(set-to-wow! z2) <span class="op">=&gt;</span> <span class="vs">'((wow b) a b)</span>

(<span class="fu">eq?</span> (<span class="fu">car</span> z1) (<span class="fu">cdr</span> z1)) <span class="op">=&gt;</span> <span class="cn">#t</span>
(<span class="fu">eq?</span> (<span class="fu">car</span> z2) (<span class="fu">cdr</span> z2)) <span class="op">=&gt;</span> <span class="cn">#f</span></code></pre>
<h3 id="ex3.15" class="anchor">
<a class="anchor__link link" href="#ex3.15" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.15">Exercise 3.15<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<p>In <code>z1</code>, the <code>car</code> and <code>cdr</code> both point to <code>x</code>:</p>
<pre><code class="blockcode"><span class="co">; z1-&gt;[*|*]
;      | |
;      V V
;  x-&gt;[*|*]-&gt;[*|X]
;      |      |
;      V      V
;      a      b</span></code></pre>
<p>After <code>set-to-wow!</code>, the <code>a</code> becomes <code>wow</code> for both <code>car</code> and <code>cdr</code>:</p>
<pre><code class="blockcode"><span class="co">; z1-&gt;[*|*]
;      | |
;      V V
;  x-&gt;[*|*]-&gt;[*|X]
;      |      |
;      V      V
;     wow     b</span></code></pre>
<p>In <code>z2</code>, the <code>car</code> and <code>cdr</code> point to different cons cells:</p>
<pre><code class="blockcode"><span class="co">; z2-&gt;[*|*]-&gt;[*|*]-&gt;[*|X]
;      |      |      |
;      |      +-&gt; a  +-&gt; b
;      V
;    [*|*]-&gt;[*|X]
;     |      |
;     +-&gt; a  +-&gt; b</span></code></pre>
<p>After <code>set-to-wow!</code>, the <code>a</code> becomes <code>wow</code> only for the <code>car</code>:</p>
<pre><code class="blockcode"><span class="co">; z2-&gt;[*|*]-&gt;[*|*]-&gt;[*|X]
;      |      |      |
;      |      +-&gt; a  +-&gt; b
;      V
;    [*|*]---&gt;[*|X]
;     |        |
;     +-&gt; wow  +-&gt; b</span></code></pre>
<h3 id="ex3.16" class="anchor">
<a class="anchor__link link" href="#ex3.16" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.16">Exercise 3.16<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<pre><code class="blockcode">(<span class="kw">define</span> (count-pairs x)
  (<span class="kw">if</span> (<span class="fu">not</span> (<span class="fu">pair?</span> x))
      <span class="cn">0</span>
      (<span class="fu">+</span> (count-pairs (<span class="fu">car</span> x))
         (count-pairs (<span class="fu">cdr</span> x))
         <span class="cn">1</span>)))</code></pre>
<p>The procedure <code>count-pairs</code> is wrong because it assumes there is no sharing. The lists below named <code>N-M</code> have <code>N</code> pairs, but they use sharing so that <code>count-pairs</code> think they have <code>M</code> pairs.</p>
<pre><code class="blockcode">(<span class="kw">define</span> one-1 (<span class="fu">cons</span> <span class="vs">'a '()</span>))
(<span class="kw">define</span> two-2 (<span class="fu">cons</span> <span class="vs">'a</span> (<span class="fu">cons</span> <span class="vs">'b '()</span>)))
(<span class="kw">define</span> two-3 (<span class="fu">cons</span> one-1 one-1))
(<span class="kw">define</span> three-3 (<span class="fu">cons</span> <span class="vs">'a</span> (<span class="fu">cons</span> <span class="vs">'a</span> (<span class="fu">cons</span> <span class="vs">'a '()</span>))))
(<span class="kw">define</span> three-4 (<span class="fu">cons</span> <span class="vs">'a</span> (<span class="fu">cons</span> one-1 one-1)))
(<span class="kw">define</span> three-5 (<span class="fu">cons</span> two-2 two-2))
(<span class="kw">define</span> three-7 (<span class="fu">cons</span> two-3 two-3))

(count-pairs one-1) <span class="op">=&gt;</span> <span class="cn">1</span>
(count-pairs two-2) <span class="op">=&gt;</span> <span class="cn">2</span>
(count-pairs two-3) <span class="op">=&gt;</span> <span class="cn">3</span>
(count-pairs three-3) <span class="op">=&gt;</span> <span class="cn">3</span>
(count-pairs three-4) <span class="op">=&gt;</span> <span class="cn">4</span>
(count-pairs three-5) <span class="op">=&gt;</span> <span class="cn">5</span>
(count-pairs three-7) <span class="op">=&gt;</span> <span class="cn">7</span></code></pre>
<h3 id="ex3.17" class="anchor">
<a class="anchor__link link" href="#ex3.17" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.17">Exercise 3.17<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="../2/3.html#2.3.1">2.3.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>memq</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#ex3.16">Ex 3.16</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>one-1</code>
</li>
<li class="flat__item nowrap">
<code>three-3</code>
</li>
<li class="flat__item nowrap">
<code>three-4</code>
</li>
<li class="flat__item nowrap">
<code>three-5</code>
</li>
<li class="flat__item nowrap">
<code>three-7</code>
</li>
<li class="flat__item nowrap">
<code>two-2</code>
</li>
<li class="flat__item nowrap">
<code>two-3</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (count-pairs x)
  (<span class="kw">let</span> ((seen <span class="vs">'()</span>))
    (<span class="kw">define</span> (iter x)
      (<span class="kw">if</span> (<span class="kw">or</span> (<span class="fu">not</span> (<span class="fu">pair?</span> x)) (<span class="fu">memq</span> x seen))
          <span class="cn">0</span>
          (<span class="kw">begin</span> (<span class="kw">set!</span> seen (<span class="fu">cons</span> x seen))
                 (<span class="fu">+</span> (iter (<span class="fu">car</span> x))
                    (iter (<span class="fu">cdr</span> x))
                    <span class="cn">1</span>))))
    (iter x)))

(count-pairs one-1) <span class="op">=&gt;</span> <span class="cn">1</span>
(count-pairs two-2) <span class="op">=&gt;</span> <span class="cn">2</span>
(count-pairs two-3) <span class="op">=&gt;</span> <span class="cn">2</span>
(count-pairs three-3) <span class="op">=&gt;</span> <span class="cn">3</span>
(count-pairs three-4) <span class="op">=&gt;</span> <span class="cn">3</span>
(count-pairs three-5) <span class="op">=&gt;</span> <span class="cn">3</span>
(count-pairs three-7) <span class="op">=&gt;</span> <span class="cn">3</span></code></pre>
<h3 id="ex3.18" class="anchor">
<a class="anchor__link link" href="#ex3.18" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.18">Exercise 3.18<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="../2/3.html#2.3.1">2.3.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>memq</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#ex3.13">Ex 3.13</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>make-cycle</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (cycle? ls)
  (<span class="kw">define</span> (iter ls seen)
    (<span class="kw">and</span> (<span class="fu">pair?</span> ls)
         (<span class="kw">or</span> (<span class="fu">memq</span> ls seen)
             (iter (<span class="fu">cdr</span> ls) (<span class="fu">cons</span> ls seen)))))
  (<span class="kw">if</span> (iter ls <span class="vs">'()</span>) <span class="cn">#t #f</span>))

(cycle? (<span class="fu">list</span> <span class="cn">1 2 3</span>)) <span class="op">=&gt;</span> <span class="cn">#f</span>
(cycle? (make-cycle (<span class="fu">list</span> <span class="cn">1 2 3</span>))) <span class="op">=&gt;</span> <span class="cn">#t</span></code></pre>
<h3 id="ex3.19" class="anchor">
<a class="anchor__link link" href="#ex3.19" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.19">Exercise 3.19<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#ex3.13">Ex 3.13</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>make-cycle</code>
</li>
</ul>
</li>
</ul>
</aside>
<p>This is Floyd’s cycle-finding algorithm (the tortoise and the hare).</p>
<pre><code class="blockcode">(<span class="kw">define</span> (cycle? ls)
  (<span class="kw">define</span> (iter t h)
    (<span class="kw">and</span> (<span class="fu">pair?</span> h)
         (<span class="fu">pair?</span> (<span class="fu">cdr</span> h))
         (<span class="kw">or</span> (<span class="fu">eq?</span> t h)
             (iter (<span class="fu">cdr</span> t) (<span class="fu">cddr</span> h)))))
  (<span class="kw">and</span> (<span class="fu">pair?</span> ls)
       (iter ls (<span class="fu">cdr</span> ls))))

(cycle? (<span class="fu">list</span> <span class="cn">1 2 3</span>)) <span class="op">=&gt;</span> <span class="cn">#f</span>
(cycle? (make-cycle (<span class="fu">list</span> <span class="cn">1 2 3</span>))) <span class="op">=&gt;</span> <span class="cn">#t</span></code></pre>
<h3 id="3.3.1.2" class="anchor">
<a class="anchor__link link" href="#3.3.1.2" aria-hidden="true">#</a> <span class="number">3.3.1.2</span> Mutation is just assignment
</h3>
<pre><code class="blockcode">(<span class="kw">define</span> (<span class="fu">cons</span> x y)
  (<span class="kw">define</span> (set-x! v) (<span class="kw">set!</span> x v))
  (<span class="kw">define</span> (set-y! v) (<span class="kw">set!</span> y v))
  (<span class="kw">define</span> (dispatch m)
    (<span class="kw">cond</span> ((<span class="fu">eq?</span> m <span class="vs">'car</span>) x)
          ((<span class="fu">eq?</span> m <span class="vs">'cdr</span>) y)
          ((<span class="fu">eq?</span> m <span class="vs">'set-car!</span>) set-x!)
          ((<span class="fu">eq?</span> m <span class="vs">'set-cdr!</span>) set-y!)
          (<span class="kw">else</span> (<span class="fu">error</span> <span class="vs">'cons</span> <span class="cn">"undefined operation"</span> m))))
  dispatch)

(<span class="kw">define</span> (<span class="fu">car</span> p) (p <span class="vs">'car</span>))
(<span class="kw">define</span> (<span class="fu">cdr</span> p) (p <span class="vs">'cdr</span>))
(<span class="kw">define</span> (<span class="fu">set-car!</span> p v) ((p <span class="vs">'set-car!</span>) v) p)
(<span class="kw">define</span> (<span class="fu">set-cdr!</span> p v) ((p <span class="vs">'set-cdr!</span>) v) p)

(<span class="kw">define</span> z (<span class="fu">cons</span> <span class="vs">'a 'b</span>))
(<span class="fu">car</span> z) <span class="op">=&gt;</span> <span class="vs">'a</span>
(<span class="fu">cdr</span> z) <span class="op">=&gt;</span> <span class="vs">'b</span>
(<span class="fu">set-car!</span> z <span class="vs">'c</span>)
(<span class="fu">car</span> z) <span class="op">=&gt;</span> <span class="vs">'c</span>
(<span class="fu">set-cdr!</span> z <span class="vs">'d</span>)
(<span class="fu">cdr</span> z) <span class="op">=&gt;</span> <span class="vs">'d</span></code></pre>
<h3 id="ex3.20" class="anchor">
<a class="anchor__link link" href="#ex3.20" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.20">Exercise 3.20<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.1.2">3.3.1.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>car</code>
</li>
<li class="flat__item nowrap">
<code>cdr</code>
</li>
<li class="flat__item nowrap">
<code>cons</code>
</li>
<li class="flat__item nowrap">
<code>set-car!</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> x (<span class="fu">cons</span> <span class="cn">1 2</span>))
(<span class="kw">define</span> z (<span class="fu">cons</span> x x))
(<span class="fu">set-car!</span> (<span class="fu">cdr</span> z) <span class="cn">17</span>)
(<span class="fu">car</span> x) <span class="op">=&gt;</span> <span class="cn">17</span></code></pre>
<p>Following the arrows in the environment diagram below, we see that the <code>cdr</code> of <code>z</code> is the same pair pointed to by <code>x</code>. By changing the <code>car</code> of this pair to 17, we change <code>x</code> from <code>(<span class="cn">1 2</span>)</code> to <code>(<span class="cn">17 2</span>)</code>.</p>
<pre><code class="blockcode"><span class="co">;               ______________
; global env -&gt;| x: -+  z: ---|-----------------+
;              |_____|________|&lt;----------------|------+
;                    |    ^                     V     _|___________
;                    | E1_|___________        [*|*]-&gt;| set-x!: ... |
;                    |  | x: 1   y: 2 |        |     | set-y!: ... |
;                    |  | set-x!: ... |        V     | dispatch: --|-+
;                    |  | set-y!: ... |  params: m   | x:+   y:+   | |
;                    |  | dispatch:+  |    body: ... |___|_____|___| |
;                    |  |__________|__|  ~~~~~~~~~~~     |     |     |
;                    |   ^         |            ^--------|-----|-----+
;                    |   |         |                     |     |
;                    | +-|-----&lt;---+---------&lt;-----------+--&lt;--+
;                    | | |
;                    V V |
;                  [*|*]-+
; paramters: m   }&lt;-+
;      body: ... }</span></code></pre>
<h2 id="3.3.2" class="anchor">
<a class="anchor__link link" href="#3.3.2" aria-hidden="true">#</a> <span class="number">3.3.2</span> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_sec_3.3.2">Representing Queues<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h2>
<pre><code class="blockcode">(<span class="kw">define</span> front-ptr <span class="fu">car</span>)
(<span class="kw">define</span> rear-ptr <span class="fu">cdr</span>)
(<span class="kw">define</span> set-front-ptr! <span class="fu">set-car!</span>)
(<span class="kw">define</span> set-rear-ptr! <span class="fu">set-cdr!</span>)

(<span class="kw">define</span> (empty-queue? q) (<span class="fu">null?</span> (front-ptr q)))
(<span class="kw">define</span> (make-queue) (<span class="fu">cons</span> <span class="vs">'() '()</span>))

(<span class="kw">define</span> (front-queue q)
  (<span class="kw">if</span> (empty-queue? q)
      (<span class="fu">error</span> <span class="vs">'front-queue</span> <span class="cn">"called with an empty queue"</span> q)
      (<span class="fu">car</span> (front-ptr q))))

(<span class="kw">define</span> (insert-queue! q x)
  (<span class="kw">let</span> ((new-pair (<span class="fu">cons</span> x <span class="vs">'()</span>)))
    (<span class="kw">cond</span> ((empty-queue? q)
           (set-front-ptr! q new-pair)
           (set-rear-ptr! q new-pair)
           q)
          (*stack-mode*
           (<span class="fu">set-cdr!</span> new-pair (front-ptr q))
           (set-front-ptr! q new-pair))
          (<span class="kw">else</span>
           (<span class="fu">set-cdr!</span> (rear-ptr q) new-pair)
           (set-rear-ptr! q new-pair)
           q))))

(<span class="kw">define</span> (delete-queue! q)
  (<span class="kw">cond</span> ((empty-queue? q)
         (<span class="fu">error</span> <span class="vs">'delete-queue!</span> <span class="cn">"called with an empty queue"</span> q))
        (<span class="kw">else</span> (set-front-ptr! q (<span class="fu">cdr</span> (front-ptr q)))
              q)))</code></pre>
<p>Make the queue behave as a stack (FILO insertion). Used in Exercise 3.32.</p>
<pre><code class="blockcode">(<span class="kw">define</span> *stack-mode* <span class="cn">#f</span>)
(<span class="kw">define</span> (enable-stack-mode) (<span class="kw">set!</span> *stack-mode* <span class="cn">#t</span>))
(<span class="kw">define</span> (disable-stack-mode) (<span class="kw">set!</span> *stack-mode* <span class="cn">#f</span>))</code></pre>
<h3 id="ex3.21" class="anchor">
<a class="anchor__link link" href="#ex3.21" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.21">Exercise 3.21<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.2">3.3.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>delete-queue!</code>
</li>
<li class="flat__item nowrap">
<code>front-ptr</code>
</li>
<li class="flat__item nowrap">
<code>insert-queue!</code>
</li>
<li class="flat__item nowrap">
<code>make-queue</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> q1 (make-queue))
(insert-queue! q1 <span class="vs">'a</span>) <span class="op">=&gt;</span> <span class="vs">'((a) a)</span>
(insert-queue! q1 <span class="vs">'b</span>) <span class="op">=&gt;</span> <span class="vs">'((a b) b)</span>
(delete-queue! q1) <span class="op">=&gt;</span> <span class="vs">'((b) b)</span>
(delete-queue! q1) <span class="op">=&gt;</span> <span class="vs">'(() b)</span></code></pre>
<p>Eva Lu Ator points out that Lisp is trying to print the list structure that makes up the queue. It doesn’t know anything special about our queue representation. The interpreter’s response isn’t a list of things in the queue, it is the queue as we decided to represent it. It is a bit more clear if we print the lists in dotted cons notation:</p>
<pre><code class="blockcode"><span class="co">; list repr.      front    rear
; ((a) a)     =   ((a)   . (a))
; ((a b) b)   =   ((a b) . (b))
; ((b) b)     =   ((b)   . (b))
; (() b)      =   (()    . (b))</span></code></pre>
<p>Now, it is clear that Lisp is showing us the front pointer and the rear pointer, interpreting both as ordinary lists. This works fine for the front pointer, and in fact we can just look at it by itself to see everything in our queue. The rear pointer is always displayed as a list with one item because the <code>cdr</code> of the last item is always null. Even when we delete all the items, we still see the last item in the queue because of the way we implemented <code>delete-queue!</code>.</p>
<pre><code class="blockcode">(<span class="kw">define</span> (print-queue q)
  (<span class="fu">display</span> (front-ptr q))
  (<span class="fu">newline</span>))

(insert-queue! q1 <span class="vs">'c</span>)
(insert-queue! q1 <span class="vs">'d</span>)
(print-queue q1) <span class="op">=$&gt;</span> <span class="cn">"(c d)</span><span class="co">\n</span><span class="cn">"</span></code></pre>
<h3 id="ex3.22" class="anchor">
<a class="anchor__link link" href="#ex3.22" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.22">Exercise 3.22<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<p>It’s interesting how I ended up using <code>dispatch</code> like you would use the <code>this</code> keyword in object-oriented languages. Another interesting point is the application of procedures in <code>dispatch</code>. For procedures that take arguments other than the queue itself, like for insertion, we have to return the procedure that can then be applied to the argument(s). In this case, the rest of the operations take no other arguments. It might be more consistent to return a procedure of zero arguments—then we would need double parentheses, like <code>((my-queue <span class="vs">'front-queue</span>))</code>—but this seems a bit strange. Instead, we apply the procedure right away in <code>dispatch</code> and pass on the return value.</p>
<pre><code class="blockcode">(<span class="kw">define</span> (make-queue)
  (<span class="kw">let</span> ((front-ptr <span class="vs">'()</span>)
        (rear-ptr <span class="vs">'()</span>))
    (<span class="kw">define</span> (empty?)
      (<span class="fu">null?</span> front-ptr))
    (<span class="kw">define</span> (insert! x)
      (<span class="kw">let</span> ((new-pair (<span class="fu">cons</span> x <span class="vs">'()</span>)))
        (<span class="kw">cond</span> ((empty?)
               (<span class="kw">set!</span> front-ptr new-pair)
               (<span class="kw">set!</span> rear-ptr new-pair)
               dispatch)
              (<span class="kw">else</span> (<span class="fu">set-cdr!</span> rear-ptr new-pair)
                    (<span class="kw">set!</span> rear-ptr new-pair)
                    dispatch))))
    (<span class="kw">define</span> (delete!)
      (<span class="kw">if</span> (empty?)
          (<span class="fu">error</span> <span class="vs">'delete!</span> <span class="cn">"called with an empty queue"</span>)
          (<span class="kw">begin</span> (<span class="kw">set!</span> front-ptr (<span class="fu">cdr</span> front-ptr))
                 dispatch)))
    (<span class="kw">define</span> (dispatch m)
      (<span class="kw">cond</span> ((<span class="fu">eq?</span> m <span class="vs">'empty-queue?</span>) (empty?))
            ((<span class="fu">eq?</span> m <span class="vs">'front-queue</span>)
             (<span class="kw">if</span> (empty?)
                 (<span class="fu">error</span> <span class="vs">'front-queue</span> <span class="cn">"called with an empty queue"</span>)
                 (<span class="fu">car</span> front-ptr)))
            ((<span class="fu">eq?</span> m <span class="vs">'insert-queue!</span>) insert!)
            ((<span class="fu">eq?</span> m <span class="vs">'delete-queue!</span>) (delete!))
            (<span class="kw">else</span> (<span class="fu">error</span> <span class="vs">'make-queue</span> <span class="cn">"undefined operation"</span> m))))
    dispatch))

(<span class="kw">define</span> q (make-queue))
(q <span class="vs">'empty-queue?</span>) <span class="op">=&gt;</span> <span class="cn">#t</span>
((q <span class="vs">'insert-queue!</span>) <span class="vs">'a</span>)
((q <span class="vs">'insert-queue!</span>) <span class="vs">'b</span>)
(q <span class="vs">'empty-queue?</span>) <span class="op">=&gt;</span> <span class="cn">#f</span>
(q <span class="vs">'front-queue</span>) <span class="op">=&gt;</span> <span class="vs">'a</span>
(q <span class="vs">'delete-queue!</span>)
(q <span class="vs">'front-queue</span>) <span class="op">=&gt;</span> <span class="vs">'b</span>
(q <span class="vs">'delete-queue!</span>)
(q <span class="vs">'empty-queue?</span>) <span class="op">=&gt;</span> <span class="cn">#t</span>
(q <span class="vs">'front-queue</span>) <span class="er">=!&gt;</span> <span class="cn">"called with an empty queue"</span>
(q <span class="vs">'delete-queue!</span>) <span class="er">=!&gt;</span> <span class="cn">"called with an empty queue"</span></code></pre>
<h3 id="ex3.23" class="anchor">
<a class="anchor__link link" href="#ex3.23" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.23">Exercise 3.23<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<p>I have implemented the deque as a doubly-linked list. Instead of pointing to the next element, the <code>cdr</code> of each item is a pair whose <code>car</code> points to the previous item and whose <code>cdr</code> points to the next. We call the items nodes:</p>
<pre><code class="blockcode">(<span class="kw">define</span> (make-node x prev next) (<span class="fu">cons</span> x (<span class="fu">cons</span> prev next)))
(<span class="kw">define</span> (data-node node) (<span class="fu">car</span> node))
(<span class="kw">define</span> (prev-node node) (<span class="fu">cadr</span> node))
(<span class="kw">define</span> (next-node node) (<span class="fu">cddr</span> node))
(<span class="kw">define</span> (set-prev! node prev) (<span class="fu">set-car!</span> (<span class="fu">cdr</span> node) prev))
(<span class="kw">define</span> (set-next! node next) (<span class="fu">set-cdr!</span> (<span class="fu">cdr</span> node) next))

(<span class="kw">define</span> (front-ptr dq) (<span class="fu">car</span> dq))
(<span class="kw">define</span> (rear-ptr dq) (<span class="fu">cdr</span> dq))
(<span class="kw">define</span> (set-front-ptr! dq x) (<span class="fu">set-car!</span> dq x))
(<span class="kw">define</span> (set-rear-ptr! dq x) (<span class="fu">set-cdr!</span> dq x))
(<span class="kw">define</span> (make-deque) (<span class="fu">cons</span> <span class="vs">'() '()</span>))

(<span class="kw">define</span> (empty-deque? dq) (<span class="fu">null?</span> (front-ptr dq)))
(<span class="kw">define</span> (front-deque dq)
  (<span class="kw">if</span> (empty-deque? dq)
      (<span class="fu">error</span> <span class="vs">'front-deque</span> <span class="cn">"called with an empty deque"</span> dq)
      (data-node (front-ptr dq))))
(<span class="kw">define</span> (rear-deque dq)
  (<span class="kw">if</span> (empty-deque? dq)
      (<span class="fu">error</span> <span class="vs">'rear-deque</span> <span class="cn">"called with an empty deque"</span> dq)
      (data-node (rear-ptr dq))))

(<span class="kw">define</span> (front-insert-deque! dq x)
  (<span class="kw">cond</span> ((empty-deque? dq)
         (<span class="kw">let</span> ((node (make-node x <span class="vs">'() '()</span>)))
           (set-front-ptr! dq node)
           (set-rear-ptr! dq node)
           dq))
        (<span class="kw">else</span>
         (<span class="kw">let*</span> ((old-front (front-ptr dq))
                (new-front (make-node x <span class="vs">'()</span> old-front)))
           (set-prev! old-front new-front)
           (set-front-ptr! dq new-front)
           dq))))

(<span class="kw">define</span> (rear-insert-deque! dq x)
  (<span class="kw">cond</span> ((empty-deque? dq)
         (front-insert-deque! dq x))
        (<span class="kw">else</span>
         (<span class="kw">let*</span> ((old-rear (rear-ptr dq))
                (new-rear (make-node x old-rear <span class="vs">'()</span>)))
           (set-next! old-rear new-rear)
           (set-rear-ptr! dq new-rear)
           dq))))

(<span class="kw">define</span> (front-delete-deque! dq)
  (<span class="kw">cond</span> ((empty-deque? dq)
         (<span class="fu">error</span> <span class="vs">'front-delete-deque!</span> <span class="cn">"called with an empty deque"</span> dq))
        (<span class="kw">else</span>
         (<span class="kw">let*</span> ((old-front (front-ptr dq))
                (new-front (next-node old-front)))
           (<span class="kw">cond</span> ((<span class="fu">null?</span> new-front)
                  (set-front-ptr! dq <span class="vs">'()</span>)
                  (set-rear-ptr! dq <span class="vs">'()</span>)
                  dq)
                 (<span class="kw">else</span> (set-prev! new-front <span class="vs">'()</span>)
                       (set-front-ptr! dq new-front)
                       dq))))))

(<span class="kw">define</span> (rear-delete-deque! dq)
  (<span class="kw">cond</span> ((empty-deque? dq)
         (<span class="fu">error</span> <span class="vs">'rear-delete-deque!</span> <span class="cn">"called with an empty deque"</span> dq))
        (<span class="kw">else</span>
         (<span class="kw">let*</span> ((old-rear (rear-ptr dq))
                (new-rear (prev-node old-rear)))
           (<span class="kw">cond</span> ((<span class="fu">null?</span> new-rear)
                  (front-delete-deque! dq))
                 (<span class="kw">else</span> (set-next! new-rear <span class="vs">'()</span>)
                       (set-rear-ptr! dq new-rear)
                       dq))))))

(<span class="kw">define</span> (print-deque dq)
  (<span class="kw">define</span> (iter node first)
    (when (<span class="fu">not</span> (<span class="fu">null?</span> node))
      (when (<span class="fu">not</span> first) (<span class="fu">display</span> <span class="cn">", "</span>))
      (<span class="fu">display</span> (data-node node))
      (iter (next-node node) <span class="cn">#f</span>)))
  (<span class="fu">display</span> <span class="cn">"["</span>)
  (iter (front-ptr dq) <span class="cn">#t</span>)
  (<span class="fu">display</span> <span class="cn">"]"</span>)
  (<span class="fu">newline</span>))

(<span class="kw">define</span> dq (make-deque))
(empty-deque? dq) <span class="op">=&gt;</span> <span class="cn">#t</span>
(print-deque dq) <span class="op">=$&gt;</span> <span class="cn">"[]</span><span class="co">\n</span><span class="cn">"</span>
(front-insert-deque! dq <span class="vs">'b</span>)
(empty-deque? dq) <span class="op">=&gt;</span> <span class="cn">#f</span>
(rear-insert-deque! dq <span class="vs">'c</span>)
(front-insert-deque! dq <span class="vs">'a</span>)
(print-deque dq) <span class="op">=$&gt;</span> <span class="cn">"[a, b, c]</span><span class="co">\n</span><span class="cn">"</span>
(rear-delete-deque! dq)
(print-deque dq) <span class="op">=$&gt;</span> <span class="cn">"[a, b]</span><span class="co">\n</span><span class="cn">"</span>
(front-delete-deque! dq)
(print-deque dq) <span class="op">=$&gt;</span> <span class="cn">"[b]</span><span class="co">\n</span><span class="cn">"</span>
(rear-delete-deque! dq)
(empty-deque? dq) <span class="op">=&gt;</span> <span class="cn">#t</span>
(front-deque dq) <span class="er">=!&gt;</span> <span class="cn">"called with an empty deque"</span>
(front-delete-deque! dq) <span class="er">=!&gt;</span> <span class="cn">"called with an empty deque"</span>
(rear-delete-deque! dq) <span class="er">=!&gt;</span> <span class="cn">"called with an empty deque"</span></code></pre>
<h2 id="3.3.3" class="anchor">
<a class="anchor__link link" href="#3.3.3" aria-hidden="true">#</a> <span class="number">3.3.3</span> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_sec_3.3.3">Representing Tables<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h2>
<h3 id="3.3.3.1" class="anchor">
<a class="anchor__link link" href="#3.3.3.1" aria-hidden="true">#</a> <span class="number">3.3.3.1</span> One-dimensional tables
</h3>
<pre><code class="blockcode">(<span class="kw">define</span> (lookup key table)
  (<span class="kw">let</span> ((record (<span class="fu">assoc</span> key (<span class="fu">cdr</span> table))))
    (<span class="kw">if</span> record
        (<span class="fu">cdr</span> record)
        <span class="cn">#f</span>)))

(<span class="kw">define</span> (<span class="fu">assoc</span> key records)
  (<span class="kw">cond</span> ((<span class="fu">null?</span> records) <span class="cn">#f</span>)
        ((<span class="fu">equal?</span> key (<span class="fu">caar</span> records)) (<span class="fu">car</span> records))
        (<span class="kw">else</span> (<span class="fu">assoc</span> key (<span class="fu">cdr</span> records)))))

(<span class="kw">define</span> (insert! key value table)
  (<span class="kw">let</span> ((record (<span class="fu">assoc</span> key (<span class="fu">cdr</span> table))))
    (<span class="kw">if</span> record
        (<span class="fu">set-cdr!</span> record value)
        (<span class="fu">set-cdr!</span> table
                  (<span class="fu">cons</span> (<span class="fu">cons</span> key value)
                        (<span class="fu">cdr</span> table))))))

(<span class="kw">define</span> (make-table) (<span class="fu">list</span> <span class="vs">'*table*</span>))

(<span class="kw">define</span> t (make-table))
(lookup <span class="vs">'a</span> t) <span class="op">=&gt;</span> <span class="cn">#f</span>
(insert! <span class="vs">'a</span> <span class="cn">1</span> t)
(lookup <span class="vs">'a</span> t) <span class="op">=&gt;</span> <span class="cn">1</span></code></pre>
<h3 id="3.3.3.2" class="anchor">
<a class="anchor__link link" href="#3.3.3.2" aria-hidden="true">#</a> <span class="number">3.3.3.2</span> Two-dimensional tables
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.3.1">3.3.3.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>assoc</code>
</li>
<li class="flat__item nowrap">
<code>make-table</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (lookup key-1 key-2 table)
  (<span class="kw">let</span> ((subtable (<span class="fu">assoc</span> key-1 (<span class="fu">cdr</span> table))))
    (<span class="kw">if</span> subtable
        (<span class="kw">let</span> ((record (<span class="fu">assoc</span> key-2 (<span class="fu">cdr</span> subtable))))
          (<span class="kw">if</span> record
              (<span class="fu">cdr</span> record)
              <span class="cn">#f</span>))
        <span class="cn">#f</span>)))

(<span class="kw">define</span> (insert! key-1 key-2 value table)
  (<span class="kw">let</span> ((subtable (<span class="fu">assoc</span> key-1 (<span class="fu">cdr</span> table))))
    (<span class="kw">if</span> subtable
        (<span class="kw">let</span> ((record (<span class="fu">assoc</span> key-2 (<span class="fu">cdr</span> subtable))))
          (<span class="kw">if</span> record
              (<span class="fu">set-cdr!</span> record value)
              (<span class="fu">set-cdr!</span> subtable
                        (<span class="fu">cons</span> (<span class="fu">cons</span> key-2 value)
                              (<span class="fu">cdr</span> subtable)))))
        (<span class="fu">set-cdr!</span> table
                  (<span class="fu">cons</span> (<span class="fu">list</span> key-1 (<span class="fu">cons</span> key-2 value))
                        (<span class="fu">cdr</span> table))))))

(<span class="kw">define</span> t (make-table))
(lookup <span class="vs">'a 'b</span> t) <span class="op">=&gt;</span> <span class="cn">#f</span>
(insert! <span class="vs">'a 'b</span> <span class="cn">1</span> t)
(lookup <span class="vs">'a 'b</span> t) <span class="op">=&gt;</span> <span class="cn">1</span>
(insert! <span class="vs">'a 'c</span> <span class="cn">2</span> t)
(insert! <span class="vs">'x 'x</span> <span class="cn">3</span> t)
(lookup <span class="vs">'a 'c</span> t) <span class="op">=&gt;</span> <span class="cn">2</span>
(lookup <span class="vs">'x 'x</span> t) <span class="op">=&gt;</span> <span class="cn">3</span></code></pre>
<h3 id="3.3.3.3" class="anchor">
<a class="anchor__link link" href="#3.3.3.3" aria-hidden="true">#</a> <span class="number">3.3.3.3</span> Creating local tables
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.3.1">3.3.3.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>assoc</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (make-table)
  (<span class="kw">let</span> ((local-table (<span class="fu">list</span> <span class="vs">'*table*</span>)))
    (<span class="kw">define</span> (lookup key-1 key-2)
      (<span class="kw">let</span> ((subtable (<span class="fu">assoc</span> key-1 (<span class="fu">cdr</span> local-table))))
        (<span class="kw">if</span> subtable
            (<span class="kw">let</span> ((record (<span class="fu">assoc</span> key-2 (<span class="fu">cdr</span> subtable))))
              (<span class="kw">if</span> record (<span class="fu">cdr</span> record) <span class="cn">#f</span>))
            <span class="cn">#f</span>)))
    (<span class="kw">define</span> (insert! key-1 key-2 value)
      (<span class="kw">let</span> ((subtable (<span class="fu">assoc</span> key-1 (<span class="fu">cdr</span> local-table))))
        (<span class="kw">if</span> subtable
            (<span class="kw">let</span> ((record (<span class="fu">assoc</span> key-2 (<span class="fu">cdr</span> subtable))))
              (<span class="kw">if</span> record
                  (<span class="fu">set-cdr!</span> record value)
                  (<span class="fu">set-cdr!</span> subtable
                            (<span class="fu">cons</span> (<span class="fu">cons</span> key-2 value)
                                  (<span class="fu">cdr</span> subtable)))))
            (<span class="fu">set-cdr!</span> local-table
                      (<span class="fu">cons</span> (<span class="fu">list</span> key-1 (<span class="fu">cons</span> key-2 value))
                            (<span class="fu">cdr</span> local-table))))))
    (<span class="kw">define</span> (reset!)
      (<span class="fu">set-cdr!</span> local-table <span class="vs">'()</span>))
    (<span class="kw">define</span> (dispatch m)
      (<span class="kw">cond</span> ((<span class="fu">eq?</span> m <span class="vs">'lookup-proc</span>) lookup)
            ((<span class="fu">eq?</span> m <span class="vs">'insert-proc!</span>) insert!)
            ((<span class="fu">eq?</span> m <span class="vs">'reset-proc!</span>) reset!)
            (<span class="kw">else</span> (<span class="fu">error</span> <span class="vs">'make-table</span> <span class="cn">"unknown operation"</span> m))))
    dispatch))</code></pre>
<p>This is used extensively in <a href="../2/index.html">Chapter&nbsp;2</a>.</p>
<pre><code class="blockcode">(<span class="kw">define</span> operation-table (make-table))
(<span class="kw">define</span> get (operation-table <span class="vs">'lookup-proc</span>))
(<span class="kw">define</span> put (operation-table <span class="vs">'insert-proc!</span>))
(<span class="kw">define</span> reset (operation-table <span class="vs">'reset-proc!</span>))</code></pre>
<h3 id="ex3.24" class="anchor">
<a class="anchor__link link" href="#ex3.24" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.24">Exercise 3.24<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<p>Other than the argument <code>same-key?</code> and the internal procedure <code>assoc</code>, this is the same code as in Section 3.3.3.3.</p>
<pre><code class="blockcode">(<span class="kw">define</span> (make-table same-key?)
  (<span class="kw">define</span> (<span class="fu">assoc</span> key records)
    (<span class="kw">cond</span> ((<span class="fu">null?</span> records) <span class="cn">#f</span>)
          ((same-key? key (<span class="fu">caar</span> records)) (<span class="fu">car</span> records))
          (<span class="kw">else</span> (<span class="fu">assoc</span> key (<span class="fu">cdr</span> records)))))
  (<span class="kw">let</span> ((local-table (<span class="fu">list</span> <span class="vs">'*table*</span>)))
    (<span class="kw">define</span> (lookup key-1 key-2)
      (<span class="kw">let</span> ((subtable (<span class="fu">assoc</span> key-1 (<span class="fu">cdr</span> local-table))))
        (<span class="kw">if</span> subtable
            (<span class="kw">let</span> ((record (<span class="fu">assoc</span> key-2 (<span class="fu">cdr</span> subtable))))
              (<span class="kw">if</span> record (<span class="fu">cdr</span> record) <span class="cn">#f</span>))
            <span class="cn">#f</span>)))
    (<span class="kw">define</span> (insert! key-1 key-2 value)
      (<span class="kw">let</span> ((subtable (<span class="fu">assoc</span> key-1 (<span class="fu">cdr</span> local-table))))
        (<span class="kw">if</span> subtable
            (<span class="kw">let</span> ((record (<span class="fu">assoc</span> key-2 (<span class="fu">cdr</span> subtable))))
              (<span class="kw">if</span> record
                  (<span class="fu">set-cdr!</span> record value)
                  (<span class="fu">set-cdr!</span> subtable
                            (<span class="fu">cons</span> (<span class="fu">cons</span> key-2 value)
                                  (<span class="fu">cdr</span> subtable)))))
            (<span class="fu">set-cdr!</span> local-table
                      (<span class="fu">cons</span> (<span class="fu">list</span> key-1 (<span class="fu">cons</span> key-2 value))
                            (<span class="fu">cdr</span> local-table))))))
    (<span class="kw">define</span> (dispatch m)
      (<span class="kw">cond</span> ((<span class="fu">eq?</span> m <span class="vs">'lookup-proc</span>) lookup)
            ((<span class="fu">eq?</span> m <span class="vs">'insert-proc!</span>) insert!)
            (<span class="kw">else</span> (<span class="fu">error</span> <span class="vs">'dispatch</span> <span class="cn">"unknown operation"</span> m))))
    dispatch))

(<span class="kw">define</span> table (make-table (<span class="kw">lambda</span> (x y) (<span class="fu">&lt;</span> (<span class="fu">abs</span> (<span class="fu">-</span> x y)) <span class="cn">10</span>))))
((table <span class="vs">'insert-proc!</span>) <span class="cn">0 0</span> <span class="vs">'a</span>)
((table <span class="vs">'lookup-proc</span>) <span class="cn">0 0</span>) <span class="op">=&gt;</span> <span class="vs">'a</span>
((table <span class="vs">'lookup-proc</span>) <span class="cn">2 3</span>) <span class="op">=&gt;</span> <span class="vs">'a</span>
((table <span class="vs">'lookup-proc</span>) <span class="cn">-9 9</span>) <span class="op">=&gt;</span> <span class="vs">'a</span></code></pre>
<h3 id="ex3.25" class="anchor">
<a class="anchor__link link" href="#ex3.25" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.25">Exercise 3.25<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.3.1">3.3.3.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>assoc</code>
</li>
<li class="flat__item nowrap">
<code>make-table</code>
</li>
</ul>
</li>
</ul>
</aside>
<p>A table is a pair <code>(key . records)</code>, where <code>records</code> is an alist. Each alist entry is either <code>(key . value)</code>. If <code>value</code> is a list, then the entry is a subtable. The root key is the symbol <code>*table*</code>. To allow storing values at a key which is a prefix of other keys, we use a sentinel key <code>()</code>.</p>
<pre><code class="blockcode">(<span class="kw">define</span> (lookup keys table)
  (<span class="kw">let</span> ((value (<span class="fu">cdr</span> table)))
    (<span class="kw">cond</span> ((<span class="fu">null?</span> keys)
           (<span class="kw">if</span> (<span class="fu">list?</span> value)
               (lookup <span class="vs">'(())</span> table)
               value))
          ((<span class="fu">list?</span> value)
           (<span class="kw">let</span> ((subtable (<span class="fu">assoc</span> (<span class="fu">car</span> keys) value)))
             (<span class="kw">and</span> subtable (lookup (<span class="fu">cdr</span> keys) subtable))))
          (<span class="kw">else</span> <span class="cn">#f</span>))))

(<span class="kw">define</span> (insert! keys value table)
  (<span class="kw">define</span> (iter keys table)
    (<span class="kw">let</span> ((old-value (<span class="fu">cdr</span> table)))
      (<span class="kw">cond</span> ((<span class="fu">null?</span> keys) (<span class="fu">set-cdr!</span> table value))
            ((<span class="fu">list?</span> old-value)
             (<span class="kw">let</span> ((subtable (<span class="fu">assoc</span> (<span class="fu">car</span> keys) old-value)))
               (<span class="kw">if</span> subtable
                   (iter (<span class="fu">cdr</span> keys) subtable)
                   (<span class="kw">let</span> ((new-subtable (<span class="fu">cons</span> (<span class="fu">car</span> keys) <span class="vs">'()</span>)))
                     (<span class="fu">set-cdr!</span> table (<span class="fu">cons</span> new-subtable old-value))
                     (iter (<span class="fu">cdr</span> keys) new-subtable)))))
            (<span class="kw">else</span> (<span class="fu">set-cdr!</span> table (<span class="fu">list</span> (<span class="fu">cons</span> <span class="vs">'()</span> old-value)))
                  (iter keys table)))))
  (iter keys table))

(<span class="kw">define</span> table (make-table))

(insert! <span class="vs">'(a)</span> <span class="cn">1</span> table)
(insert! <span class="vs">'(a b c)</span> <span class="cn">2</span> table)
(insert! <span class="vs">'(d)</span> <span class="cn">3</span> table)
(insert! <span class="vs">'(e f)</span> <span class="cn">4</span> table)
(insert! <span class="vs">'(e g h)</span> <span class="cn">5</span> table)

(lookup <span class="vs">'(a)</span> table) <span class="op">=&gt;</span> <span class="cn">1</span>
(lookup <span class="vs">'(a b c)</span> table) <span class="op">=&gt;</span> <span class="cn">2</span>
(lookup <span class="vs">'(d)</span> table) <span class="op">=&gt;</span> <span class="cn">3</span>
(lookup <span class="vs">'(e f)</span> table) <span class="op">=&gt;</span> <span class="cn">4</span>
(lookup <span class="vs">'(e g h)</span> table) <span class="op">=&gt;</span> <span class="cn">5</span>

(lookup <span class="vs">'(a b)</span> table) <span class="op">=&gt;</span> <span class="cn">#f</span>
(lookup <span class="vs">'(a b c d)</span> table) <span class="op">=&gt;</span> <span class="cn">#f</span>
(lookup <span class="vs">'(z)</span> table) <span class="op">=&gt;</span> <span class="cn">#f</span></code></pre>
<h3 id="ex3.26" class="anchor">
<a class="anchor__link link" href="#ex3.26" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.26">Exercise 3.26<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.3.1">3.3.3.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>make-table</code>
</li>
</ul>
</li>
</ul>
</aside>
<p>A table is a pair whose <code>cdr</code> is a node. A node is either null or has the form <code>((key . value) . (left . right))</code> where <code>left</code> and <code>right</code> are nodes.</p>
<pre><code class="blockcode">(<span class="kw">define</span> (lookup key table)
  (<span class="kw">define</span> (iter node)
    (<span class="kw">if</span> (<span class="fu">null?</span> node)
        <span class="cn">#f</span>
        (<span class="kw">let</span> ((node-key (<span class="fu">caar</span> node)))
          (<span class="kw">cond</span> ((<span class="fu">=</span> key node-key) (<span class="fu">cdar</span> node))
                ((<span class="fu">&lt;</span> key node-key) (iter (<span class="fu">cadr</span> node)))
                ((<span class="fu">&gt;</span> key node-key) (iter (<span class="fu">cddr</span> node)))))))
  (iter (<span class="fu">cdr</span> table)))

(<span class="kw">define</span> (insert! key value table)
  (<span class="kw">define</span> (iter node set-child! parent)
    (<span class="kw">if</span> (<span class="fu">null?</span> node)
        (set-child! parent (<span class="fu">cons</span> (<span class="fu">cons</span> key value) (<span class="fu">cons</span> <span class="vs">'() '()</span>)))
        (<span class="kw">let</span> ((node-key (<span class="fu">caar</span> node)))
          (<span class="kw">cond</span> ((<span class="fu">=</span> key node-key) (<span class="fu">set-cdr!</span> (<span class="fu">car</span> node) value))
                ((<span class="fu">&lt;</span> key node-key) (iter (<span class="fu">cadr</span> node) <span class="fu">set-car!</span> (<span class="fu">cdr</span> node)))
                ((<span class="fu">&gt;</span> key node-key) (iter (<span class="fu">cddr</span> node) <span class="fu">set-cdr!</span> (<span class="fu">cdr</span> node)))))))
  (iter (<span class="fu">cdr</span> table) <span class="fu">set-cdr!</span> table))

(<span class="kw">define</span> table (make-table))

(insert! <span class="cn">0</span> <span class="vs">'a</span> table)
(insert! <span class="cn">25</span> <span class="vs">'b</span> table)
(insert! <span class="cn">-3</span> <span class="vs">'c</span> table)
(insert! <span class="cn">-4</span> <span class="vs">'d</span> table)
(insert! <span class="cn">7</span> <span class="vs">'e</span> table)

(lookup <span class="cn">0</span> table) <span class="op">=&gt;</span> <span class="vs">'a</span>
(lookup <span class="cn">25</span> table) <span class="op">=&gt;</span> <span class="vs">'b</span>
(lookup <span class="cn">-3</span> table) <span class="op">=&gt;</span> <span class="vs">'c</span>
(lookup <span class="cn">-4</span> table) <span class="op">=&gt;</span> <span class="vs">'d</span>
(lookup <span class="cn">7</span> table) <span class="op">=&gt;</span> <span class="vs">'e</span></code></pre>
<h3 id="ex3.27" class="anchor">
<a class="anchor__link link" href="#ex3.27" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.27">Exercise 3.27<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.3.1">3.3.3.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>make-table</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#ex3.26">Ex 3.26</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>insert!</code>
</li>
<li class="flat__item nowrap">
<code>lookup</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (memoize f)
  (<span class="kw">let</span> ((table (make-table)))
    (<span class="kw">lambda</span> (x)
      (<span class="kw">let</span> ((cached (lookup x table)))
        (<span class="kw">or</span> cached
            (<span class="kw">let</span> ((result (f x)))
              (insert! x result table)
              result))))))

(<span class="kw">define</span> memo-fib
  (memoize
   (<span class="kw">lambda</span> (n)
     (<span class="kw">cond</span> ((<span class="fu">=</span> n <span class="cn">0</span>) <span class="cn">0</span>)
           ((<span class="fu">=</span> n <span class="cn">1</span>) <span class="cn">1</span>)
           (<span class="kw">else</span> (<span class="fu">+</span> (memo-fib (<span class="fu">-</span> n <span class="cn">1</span>))
                    (memo-fib (<span class="fu">-</span> n <span class="cn">2</span>))))))))

(memo-fib <span class="cn">6</span>) <span class="op">=&gt;</span> <span class="cn">8</span>
(memo-fib <span class="cn">100</span>) <span class="op">=&gt;</span> <span class="cn">354224848179261915075</span></code></pre>
<p>See whiteboard/exercise-3.27.jpg for the environment diagram.</p>
<p>The memoized procedure <code>memo-fib</code> computes the nth Fibonacci number in a number of steps proportional to <code>n</code> because it takes the sum of <code>n</code> numbers. When we evaluate <code>(memo-fib n)</code>, a tree-recursive process is generated and it descends until it reaches 0 and 1, the base cases of the recursive Fibonacci implementation. The results for these inputs are placed in the table, and then <code>(memo-fib <span class="cn">2</span>)</code> requires only one step, the addition of 0 and 1, because the values are taken from the table. In general, we descend to the bottom of the tree once and then ascend it, never again going down and reaching duplicate leaves. This is twice <code>n</code> steps, so it grows as O(n).</p>
<p>If we had defined <code>memo-fib</code> as <code>(memoize fib)</code>, it would not work because recursive calls would use <code>fib</code>, not <code>memo-fib</code>, and so we would still have an exponential number of steps. However, this aspect of the memoization would still work: if you evaluated <code>(memo-fib <span class="cn">42</span>)</code> twice, the second time would take only the step of looking up a value in the table.</p>
<h2 id="3.3.4" class="anchor">
<a class="anchor__link link" href="#3.3.4" aria-hidden="true">#</a> <span class="number">3.3.4</span> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_sec_3.3.4">A Simulator for Digital Circuits<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h2>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.4.1">3.3.4.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>and-gate</code>
</li>
<li class="flat__item nowrap">
<code>inverter</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.2">3.3.4.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>make-wire</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#ex3.28">Ex 3.28</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>or-gate</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (half-adder a b sum carry)
  (<span class="kw">let</span> ((d (make-wire))
        (e (make-wire)))
    (or-gate a b d)
    (and-gate a b carry)
    (inverter carry e)
    (and-gate d e sum)))

(<span class="kw">define</span> (full-adder a b c-in sum c-out)
  (<span class="kw">let</span> ((s (make-wire))
        (c1 (make-wire))
        (c2 (make-wire)))
    (half-adder a b s c1)
    (half-adder c-in s sum c2)
    (or-gate c1 c2 c-out)))</code></pre>
<h3 id="3.3.4.1" class="anchor">
<a class="anchor__link link" href="#3.3.4.1" aria-hidden="true">#</a> <span class="number">3.3.4.1</span> Primitive function boxes
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.4.2">3.3.4.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>add-action!</code>
</li>
<li class="flat__item nowrap">
<code>get-signal</code>
</li>
<li class="flat__item nowrap">
<code>set-signal!</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.3">3.3.4.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>after-delay</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> inverter-delay <span class="cn">2</span>)
(<span class="kw">define</span> and-gate-delay <span class="cn">3</span>)

(<span class="kw">define</span> (inverter input output)
  (add-action!
   input
   (<span class="kw">lambda</span> ()
     (<span class="kw">let</span> ((new-signal (logical-not (get-signal input))))
       (after-delay
        inverter-delay
        (<span class="kw">lambda</span> () (set-signal! output new-signal)))))))

(<span class="kw">define</span> (and-gate a b out)
  (<span class="kw">define</span> (action)
    (<span class="kw">let</span> ((new-signal (logical-and (get-signal a) (get-signal b))))
      (after-delay
       and-gate-delay
       (<span class="kw">lambda</span> () (set-signal! out new-signal)))))
  (add-action! a action)
  (add-action! b action))

(<span class="kw">define</span> (logical-not a) (<span class="fu">-</span> <span class="cn">1</span> a))
(<span class="kw">define</span> (logical-and a b) (<span class="fu">*</span> a b))</code></pre>
<h3 id="ex3.28" class="anchor">
<a class="anchor__link link" href="#ex3.28" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.28">Exercise 3.28<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.4.2">3.3.4.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>add-action!</code>
</li>
<li class="flat__item nowrap">
<code>get-signal</code>
</li>
<li class="flat__item nowrap">
<code>set-signal!</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.3">3.3.4.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>after-delay</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> or-gate-delay <span class="cn">5</span>)

(<span class="kw">define</span> (or-gate a b out)
  (<span class="kw">define</span> (action)
    (<span class="kw">let</span> ((new-signal (logical-or (get-signal a) (get-signal b))))
      (after-delay
       or-gate-delay
       (<span class="kw">lambda</span> () (set-signal! out new-signal)))))
  (add-action! a action)
  (add-action! b action))

(<span class="kw">define</span> (logical-or a b) (<span class="fu">-</span> (<span class="fu">+</span> a b) (<span class="fu">*</span> a b)))</code></pre>
<h3 id="ex3.29" class="anchor">
<a class="anchor__link link" href="#ex3.29" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.29">Exercise 3.29<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.4.1">3.3.4.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>and-gate</code>
</li>
<li class="flat__item nowrap">
<code>and-gate-delay</code>
</li>
<li class="flat__item nowrap">
<code>inverter</code>
</li>
<li class="flat__item nowrap">
<code>inverter-delay</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.2">3.3.4.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>make-wire</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#ex3.28">Ex 3.28</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>or-gate-delay</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (or-gate a b out)
  (<span class="kw">let</span> ((na (make-wire))
        (nb (make-wire))
        (c (make-wire)))
    (inverter a na)
    (inverter b nb)
    (and-gate na nb c)
    (inverter c out)))

(<span class="kw">define</span> compound-or-gate-delay
  (<span class="fu">+</span> and-gate-delay (<span class="fu">*</span> <span class="cn">2</span> inverter-delay)))</code></pre>
<h3 id="ex3.30" class="anchor">
<a class="anchor__link link" href="#ex3.30" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.30">Exercise 3.30<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.4">3.3.4</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>full-adder</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.1">3.3.4.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>and-gate-delay</code>
</li>
<li class="flat__item nowrap">
<code>inverter-delay</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.2">3.3.4.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>make-wire</code>
</li>
<li class="flat__item nowrap">
<code>set-signal!</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#ex3.28">Ex 3.28</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>or-gate-delay</code>
</li>
</ul>
</li>
</ul>
</aside>
<p>Adds binary numbers <code>as</code> and <code>bs</code> in little endian order.</p>
<pre><code class="blockcode">(<span class="kw">define</span> (ripple-carry-adder as bs ss carry)
  (<span class="kw">define</span> (iter as bs c-in ss)
    (<span class="kw">if</span> (<span class="fu">null?</span> (<span class="fu">cdr</span> as))
        (full-adder (<span class="fu">car</span> as) (<span class="fu">car</span> bs) c-in (<span class="fu">car</span> ss) carry)
        (<span class="kw">let</span> ((c (make-wire)))
          (full-adder (<span class="fu">car</span> as) (<span class="fu">car</span> bs) c-in (<span class="fu">car</span> ss) c)
          (iter (<span class="fu">cdr</span> as) (<span class="fu">cdr</span> bs) c (<span class="fu">cdr</span> ss)))))
  (<span class="kw">cond</span> ((<span class="fu">not</span> (<span class="fu">=</span> (<span class="fu">length</span> as) (<span class="fu">length</span> bs) (<span class="fu">length</span> ss)))
         (<span class="fu">error</span> <span class="vs">'ripple-carry-adder</span> <span class="cn">"bit width mismatch"</span> as bs ss))
        ((<span class="fu">null?</span> as)
         (<span class="fu">error</span> <span class="vs">'ripple-carry-adder</span> <span class="cn">"bit width must be at least 1"</span> as))
        (<span class="kw">else</span> (<span class="kw">let</span> ((c-in (make-wire)))
                (set-signal! c-in <span class="cn">0</span>)
                (iter as bs c-in ss)))))

(<span class="kw">define</span> half-adder-delay
  (<span class="fu">+</span> (<span class="fu">max</span> or-gate-delay
          (<span class="fu">+</span> and-gate-delay inverter-delay))
     or-gate-delay))

(<span class="kw">define</span> full-adder-delay
  (<span class="fu">+</span> (<span class="fu">*</span> <span class="cn">2</span> half-adder-delay)
     or-gate-delay))

(<span class="kw">define</span> (ripple-carry-adder-delay n)
  (<span class="fu">*</span> n full-adder-delay))</code></pre>
<h3 id="3.3.4.2" class="anchor">
<a class="anchor__link link" href="#3.3.4.2" aria-hidden="true">#</a> <span class="number">3.3.4.2</span> Representing wires
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.4.5">3.3.4.5</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>add-to-agenda!</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (make-wire)
  (<span class="kw">let</span> ((signal-value <span class="cn">0</span>)
        (action-procedures <span class="vs">'()</span>))
    (<span class="kw">define</span> (set-signal! s)
      (when (<span class="fu">not</span> (<span class="fu">=</span> signal-value s))
        (<span class="kw">set!</span> signal-value s)
        (call-each action-procedures)))
    (<span class="kw">define</span> (add-action! proc)
      (<span class="kw">set!</span> action-procedures
            (<span class="fu">cons</span> proc action-procedures))
      (proc))
    (<span class="kw">define</span> (dispatch m)
      (<span class="kw">cond</span> ((<span class="fu">eq?</span> m <span class="vs">'get-signal</span>) signal-value)
            ((<span class="fu">eq?</span> m <span class="vs">'set-signal!</span>) set-signal!)
            ((<span class="fu">eq?</span> m <span class="vs">'add-action!</span>) add-action!)
            (<span class="kw">else</span> (<span class="fu">error</span> <span class="vs">'dispatch</span> <span class="cn">"unknown operation"</span> m))))
    dispatch))

(<span class="kw">define</span> (call-each procs) (<span class="fu">for-each</span> (<span class="kw">lambda</span> (f) (f)) procs))

(<span class="kw">define</span> (get-signal wire) (wire <span class="vs">'get-signal</span>))
(<span class="kw">define</span> (set-signal! wire s) ((wire <span class="vs">'set-signal!</span>) s))
(<span class="kw">define</span> (add-action! wire a) ((wire <span class="vs">'add-action!</span>) a))</code></pre>
<h3 id="3.3.4.3" class="anchor">
<a class="anchor__link link" href="#3.3.4.3" aria-hidden="true">#</a> <span class="number">3.3.4.3</span> The agenda
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.4.5">3.3.4.5</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>add-to-agenda!</code>
</li>
<li class="flat__item nowrap">
<code>empty-agenda?</code>
</li>
<li class="flat__item nowrap">
<code>first-agenda-item</code>
</li>
<li class="flat__item nowrap">
<code>make-agenda</code>
</li>
<li class="flat__item nowrap">
<code>remove-first-agenda-item!</code>
</li>
<li class="flat__item nowrap">
<code>reset-agenda!</code>
</li>
<li class="flat__item nowrap">
<code>simulation-time</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> the-agenda (make-agenda))
(<span class="kw">define</span> (reset) (reset-agenda! the-agenda))

(<span class="kw">define</span> (after-delay delay-time action)
  (add-to-agenda! (<span class="fu">+</span> delay-time (simulation-time the-agenda))
                  action
                  the-agenda))

(<span class="kw">define</span> (propagate)
  (unless (empty-agenda? the-agenda)
    (<span class="kw">let</span> ((first-item (first-agenda-item the-agenda)))
      (first-item)
      (remove-first-agenda-item! the-agenda)
      (propagate))))</code></pre>
<h3 id="3.3.4.4" class="anchor">
<a class="anchor__link link" href="#3.3.4.4" aria-hidden="true">#</a> <span class="number">3.3.4.4</span> A sample simulation
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.4">3.3.4</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>half-adder</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.2">3.3.4.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>add-action!</code>
</li>
<li class="flat__item nowrap">
<code>get-signal</code>
</li>
<li class="flat__item nowrap">
<code>make-wire</code>
</li>
<li class="flat__item nowrap">
<code>set-signal!</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.3">3.3.4.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>propagate</code>
</li>
<li class="flat__item nowrap">
<code>reset</code>
</li>
<li class="flat__item nowrap">
<code>the-agenda</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.5">3.3.4.5</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>simulation-time</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (probe name wire)
  (add-action!
   wire
   (<span class="kw">lambda</span> ()
     (<span class="fu">display</span> (format <span class="cn">"</span><span class="co">\n</span><span class="cn">~a ~a New-value = ~a"</span>
                      name (simulation-time the-agenda) (get-signal wire))))))

(reset)
(<span class="kw">define</span> input-1 (make-wire))
(<span class="kw">define</span> input-2 (make-wire))
(<span class="kw">define</span> sum (make-wire))
(<span class="kw">define</span> carry (make-wire))

(probe <span class="vs">'sum</span> sum)
<span class="op">=$&gt;</span> [<span class="cn">"sum 0 New-value = 0"</span>]
(probe <span class="vs">'carry</span> carry)
<span class="op">=$&gt;</span> [<span class="cn">"carry 0 New-value = 0"</span>]
(half-adder input-1 input-2 sum carry)
(set-signal! input-1 <span class="cn">1</span>)
(propagate)
<span class="op">=$&gt;</span> [<span class="cn">"sum 8 New-value = 1"</span>]
(set-signal! input-2 <span class="cn">1</span>)
(propagate)
<span class="op">=$&gt;</span> [<span class="cn">"carry 11 New-value = 1"
     "sum 16 New-value = 0"</span>]</code></pre>
<h3 id="ex3.31" class="anchor">
<a class="anchor__link link" href="#ex3.31" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.31">Exercise 3.31<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.4">3.3.4</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>half-adder</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.1">3.3.4.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>inverter</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.2">3.3.4.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>get-signal</code>
</li>
<li class="flat__item nowrap">
<code>make-wire</code>
</li>
<li class="flat__item nowrap">
<code>set-signal!</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.3">3.3.4.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>propagate</code>
</li>
<li class="flat__item nowrap">
<code>reset</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.4">3.3.4.4</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>probe</code>
</li>
</ul>
</li>
</ul>
</aside>
<p>We can make wires that do not call actions immediately by wrapping actions in procedures that do nothing on their first call.</p>
<pre><code class="blockcode">(<span class="kw">define</span> (make-bad-wire)
  (<span class="kw">let</span> ((wire (make-wire)))
    (<span class="kw">lambda</span> (m)
      (<span class="kw">if</span> (<span class="fu">not</span> (<span class="fu">eq?</span> m <span class="vs">'add-action!</span>))
          (wire m)
          (<span class="kw">lambda</span> (action)
            ((wire <span class="vs">'add-action!</span>)
             (<span class="kw">let</span> ((first <span class="cn">#t</span>))
               (<span class="kw">lambda</span> ()
                 (<span class="kw">if</span> first
                     (<span class="kw">set!</span> first <span class="cn">#f</span>)
                     (action))))))))))</code></pre>
<p>Consider an inverter between two wires:</p>
<pre><code class="blockcode">(reset)
(<span class="kw">define</span> a (make-bad-wire))
(<span class="kw">define</span> b (make-bad-wire))
(get-signal a) <span class="op">=&gt;</span> <span class="cn">0</span>
(get-signal b) <span class="op">=&gt;</span> <span class="cn">0</span>
(inverter a b)</code></pre>
<p>Since <code>add-action!</code> is not calling the procedure right away, we’ve now added an action to <code>a</code> but it has not been executed. The signals haven’t changed:</p>
<pre><code class="blockcode">(get-signal a) <span class="op">=&gt;</span> <span class="cn">0</span>
(get-signal b) <span class="op">=&gt;</span> <span class="cn">0</span></code></pre>
<p>This is an incorrect state. To fix it, we’d have to flip <code>a</code> on and off. Therefore, we must execute actions right after adding them to ensure the circuit is in a stable state.</p>
<p>Let’s trace through the previous example without calling actions when they are added. Nothing is printed when we call <code>probe</code> because the probe action is not called immediately. Nothing is printed when we propagate setting <code>input-1</code> to 1 either: it flows through the OR gate, but not through the AND gate because the latter does not know its other input is 1 (that would have required propagating the 0 from <code>input-2</code> through the other AND &amp; NOT gates). Finally, when we set <code>input-2</code> to 1 and propagate, it flows through the circuit leaving <code>sum</code> at 0 (still no printing), but changing <code>carry</code> to 1 (which becomes the only thing printed).</p>
<pre><code class="blockcode">(reset)
(<span class="kw">define</span> input-1 (make-bad-wire))
(<span class="kw">define</span> input-2 (make-bad-wire))
(<span class="kw">define</span> sum (make-bad-wire))
(<span class="kw">define</span> carry (make-bad-wire))
(probe <span class="vs">'sum</span> sum) <span class="op">=$&gt;</span> <span class="cn">""</span>
(probe <span class="vs">'carry</span> carry) <span class="op">=$&gt;</span> <span class="cn">""</span>
(half-adder input-1 input-2 sum carry)
(set-signal! input-1 <span class="cn">1</span>)
(propagate) <span class="op">=$&gt;</span> <span class="cn">""</span>
(set-signal! input-2 <span class="cn">1</span>)
(propagate) <span class="op">=$&gt;</span> [<span class="cn">"carry 11 New-value = 1"</span>]</code></pre>
<h3 id="3.3.4.5" class="anchor">
<a class="anchor__link link" href="#3.3.4.5" aria-hidden="true">#</a> <span class="number">3.3.4.5</span> Implementing the agenda
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.2">3.3.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>delete-queue!</code>
</li>
<li class="flat__item nowrap">
<code>empty-queue?</code>
</li>
<li class="flat__item nowrap">
<code>front-queue</code>
</li>
<li class="flat__item nowrap">
<code>insert-queue!</code>
</li>
<li class="flat__item nowrap">
<code>make-queue</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> make-time-segment <span class="fu">cons</span>)
(<span class="kw">define</span> segment-time <span class="fu">car</span>)
(<span class="kw">define</span> segment-queue <span class="fu">cdr</span>)

(<span class="kw">define</span> (make-agenda) (<span class="fu">list</span> <span class="cn">0</span>))
(<span class="kw">define</span> (simulation-time agenda) (<span class="fu">car</span> agenda))
(<span class="kw">define</span> (set-simulation-time! agenda time) (<span class="fu">set-car!</span> agenda time))
(<span class="kw">define</span> (segments agenda) (<span class="fu">cdr</span> agenda))
(<span class="kw">define</span> (set-segments! agenda segments) (<span class="fu">set-cdr!</span> agenda segments))
(<span class="kw">define</span> (first-segment agenda) (<span class="fu">car</span> (segments agenda)))
(<span class="kw">define</span> (rest-segments agenda) (<span class="fu">cdr</span> (segments agenda)))

(<span class="kw">define</span> (empty-agenda? agenda)
  (<span class="fu">null?</span> (segments agenda)))
(<span class="kw">define</span> (reset-agenda! agenda)
  (set-simulation-time! agenda <span class="cn">0</span>)
  (set-segments! agenda <span class="vs">'()</span>))

(<span class="kw">define</span> (add-to-agenda! time action agenda)
  (<span class="kw">define</span> (belongs-before? segments)
    (<span class="kw">or</span> (<span class="fu">null?</span> segments)
        (<span class="fu">&lt;</span> time (segment-time (<span class="fu">car</span> segments)))))
  (<span class="kw">define</span> (make-new-time-segment time action)
    (<span class="kw">let</span> ((q (make-queue)))
      (insert-queue! q action)
      (make-time-segment time q)))
  (<span class="kw">define</span> (add-to-segments! segments)
    (<span class="kw">if</span> (<span class="fu">=</span> (segment-time (<span class="fu">car</span> segments)) time)
        (insert-queue! (segment-queue (<span class="fu">car</span> segments)) action)
        (<span class="kw">let</span> ((rest (<span class="fu">cdr</span> segments)))
          (<span class="kw">if</span> (belongs-before? rest)
              (<span class="fu">set-cdr!</span> segments
                        (<span class="fu">cons</span> (make-new-time-segment time action)
                              (<span class="fu">cdr</span> segments)))
              (add-to-segments! rest)))))
  (<span class="kw">let</span> ((segments (segments agenda)))
    (<span class="kw">if</span> (belongs-before? segments)
        (set-segments!
         agenda
         (<span class="fu">cons</span> (make-new-time-segment time action) segments))
        (add-to-segments! segments))))

(<span class="kw">define</span> (remove-first-agenda-item! agenda)
  (<span class="kw">let</span> ((q (segment-queue (first-segment agenda))))
    (delete-queue! q)
    (when (empty-queue? q)
      (set-segments! agenda (rest-segments agenda)))))

(<span class="kw">define</span> (first-agenda-item agenda)
  (<span class="kw">if</span> (empty-agenda? agenda)
      (<span class="fu">error</span> <span class="vs">'first-agenda-item</span> <span class="cn">"agenda is empty"</span>)
      (<span class="kw">let</span> ((first-seg (first-segment agenda)))
        (set-simulation-time! agenda (segment-time first-seg))
        (front-queue (segment-queue first-seg)))))</code></pre>
<h3 id="ex3.32" class="anchor">
<a class="anchor__link link" href="#ex3.32" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.32">Exercise 3.32<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.2">3.3.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>disable-stack-mode</code>
</li>
<li class="flat__item nowrap">
<code>enable-stack-mode</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.1">3.3.4.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>and-gate</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.2">3.3.4.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>make-wire</code>
</li>
<li class="flat__item nowrap">
<code>set-signal!</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.3">3.3.4.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>propagate</code>
</li>
<li class="flat__item nowrap">
<code>reset</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.4.4">3.3.4.4</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>probe</code>
</li>
</ul>
</li>
</ul>
</aside>
<p>The FIFO order of procedure queues for each segment must be used because it causes actions to be executed in the same order as they were triggered. If actions A1, A2, and A3 occur in that order, they will be inserted and popped in that order. Executing them in reverse order leads to different, incorrect behaviour. Consider an and-gate whose inputs change from 0, 1 to 1, 0:</p>
<pre><code class="blockcode">(reset)
(<span class="kw">define</span> a (make-wire))
(<span class="kw">define</span> b (make-wire))
(<span class="kw">define</span> c (make-wire))
(set-signal! a <span class="cn">0</span>)
(set-signal! b <span class="cn">1</span>)
(and-gate a b c)
(probe <span class="vs">'c</span> c)
<span class="op">=$&gt;</span> [<span class="cn">"c 0 New-value = 0"</span>]
(propagate) <span class="op">=$&gt;</span> <span class="cn">""</span>
(set-signal! a <span class="cn">1</span>)
(set-signal! b <span class="cn">0</span>)
(propagate)
<span class="op">=$&gt;</span> [<span class="cn">"c 6 New-value = 1"
     "c 6 New-value = 0"</span>]</code></pre>
<p>The value of <code>c</code> goes to 1, but settles to 0 once all actions are processed. If we use a stack (FILO) rather than a queue (FIFO) for actions, there will be a mismatch between the execution order and signal calculations. This is because gates calculate <code>new-signal</code> immediately, and only delay setting the output to that value. With FILO behaviour, <code>(set-signal! a <span class="cn">1</span>)</code> will create an action to set <code>c</code> to 1 (since <code>a</code> and <code>b</code> are 1). Then <code>(set-signal! b <span class="cn">0</span>)</code> will create an action to set <code>c</code> to 0, the correct final value. But the actions execute in reverse order, so <code>c</code> ends up incorrectly at 1:</p>
<pre><code class="blockcode">(enable-stack-mode)

(reset)
(<span class="kw">define</span> a (make-wire))
(<span class="kw">define</span> b (make-wire))
(<span class="kw">define</span> c (make-wire))
(set-signal! a <span class="cn">0</span>)
(set-signal! b <span class="cn">1</span>)
(and-gate a b c)
(probe <span class="vs">'c</span> c) <span class="op">=$&gt;</span> [<span class="cn">"c 0 New-value = 0"</span>]
(propagate) <span class="op">=$&gt;</span> <span class="cn">""</span>
(set-signal! a <span class="cn">1</span>)
(set-signal! b <span class="cn">0</span>)
(propagate) <span class="op">=$&gt;</span> [<span class="cn">"c 6 New-value = 1"</span>]

(disable-stack-mode)</code></pre>
<h2 id="3.3.5" class="anchor">
<a class="anchor__link link" href="#3.3.5" aria-hidden="true">#</a> <span class="number">3.3.5</span> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_sec_3.3.5">Propagation of Constraints<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h2>
<h3 id="3.3.5.1" class="anchor">
<a class="anchor__link link" href="#3.3.5.1" aria-hidden="true">#</a> <span class="number">3.3.5.1</span> Using the constraint system
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.5.2">3.3.5.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>adder</code>
</li>
<li class="flat__item nowrap">
<code>constant</code>
</li>
<li class="flat__item nowrap">
<code>multiplier</code>
</li>
<li class="flat__item nowrap">
<code>probe</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.5.3">3.3.5.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>forget-value!</code>
</li>
<li class="flat__item nowrap">
<code>make-connector</code>
</li>
<li class="flat__item nowrap">
<code>set-value!</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (celsius-fahrenheit-converter c f)
  (<span class="kw">let</span> ((u (make-connector))
        (v (make-connector))
        (w (make-connector))
        (x (make-connector))
        (y (make-connector)))
    (multiplier c w u)
    (multiplier v x u)
    (adder v y f)
    (constant <span class="cn">9</span> w)
    (constant <span class="cn">5</span> x)
    (constant <span class="cn">32</span> y)))

(<span class="kw">define</span> C (make-connector))
(<span class="kw">define</span> F (make-connector))
(celsius-fahrenheit-converter C F)
(probe <span class="cn">"Celsius temp"</span> C)
(probe <span class="cn">"Fahrenheit temp"</span> F)

(set-value! C <span class="cn">25</span> <span class="vs">'user</span>)
<span class="op">=$&gt;</span> [<span class="cn">"Probe: Celsius temp = 25"
     "Probe: Fahrenheit temp = 77"</span>]
(set-value! F <span class="cn">212</span> <span class="vs">'user</span>)
<span class="er">=!&gt;</span> <span class="cn">"contradiction: 77 212"</span>
(forget-value! C <span class="vs">'user</span>)
<span class="op">=$&gt;</span> [<span class="cn">"Probe: Celsius temp = ?"
     "Probe: Fahrenheit temp = ?"</span>]
(set-value! F <span class="cn">212</span> <span class="vs">'user</span>)
<span class="op">=$&gt;</span> [<span class="cn">"Probe: Fahrenheit temp = 212"
     "Probe: Celsius temp = 100"</span>]</code></pre>
<h3 id="3.3.5.2" class="anchor">
<a class="anchor__link link" href="#3.3.5.2" aria-hidden="true">#</a> <span class="number">3.3.5.2</span> Implementing the constraint system
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.5.3">3.3.5.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>connect</code>
</li>
<li class="flat__item nowrap">
<code>forget-value!</code>
</li>
<li class="flat__item nowrap">
<code>get-value</code>
</li>
<li class="flat__item nowrap">
<code>has-value?</code>
</li>
<li class="flat__item nowrap">
<code>set-value!</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (adder a b sum)
  (<span class="kw">define</span> (process-new-value)
    (<span class="kw">cond</span> ((<span class="kw">and</span> (has-value? a) (has-value? b))
           (set-value! sum (<span class="fu">+</span> (get-value a) (get-value b)) me))
          ((<span class="kw">and</span> (has-value? a) (has-value? sum))
           (set-value! b (<span class="fu">-</span> (get-value sum) (get-value a)) me))
          ((<span class="kw">and</span> (has-value? b) (has-value? sum))
           (set-value! a (<span class="fu">-</span> (get-value sum) (get-value b)) me))))
  (<span class="kw">define</span> (process-forget-value)
    (forget-value! sum me)
    (forget-value! a me)
    (forget-value! b me)
    (process-new-value))
  (<span class="kw">define</span> (me request)
    (<span class="kw">cond</span> ((<span class="fu">eq?</span> request <span class="vs">'I-have-a-value</span>) (process-new-value))
          ((<span class="fu">eq?</span> request <span class="vs">'I-lost-my-value</span>) (process-forget-value))
          (<span class="kw">else</span> (<span class="fu">error</span> <span class="vs">'adder</span> <span class="cn">"unknown request"</span> request))))
  (connect a me)
  (connect b me)
  (connect sum me)
  me)

(<span class="kw">define</span> (multiplier x y product)
  (<span class="kw">define</span> (process-new-value)
    (<span class="kw">cond</span> ((<span class="kw">or</span> (<span class="kw">and</span> (has-value? x) (<span class="fu">zero?</span> (get-value x)))
               (<span class="kw">and</span> (has-value? y) (<span class="fu">zero?</span> (get-value y))))
           (set-value! product <span class="cn">0</span> me))
          ((<span class="kw">and</span> (has-value? x) (has-value? y))
           (set-value! product (<span class="fu">*</span> (get-value x) (get-value y)) me))
          ((<span class="kw">and</span> (has-value? x) (has-value? product))
           (set-value! y (<span class="fu">/</span> (get-value product) (get-value x)) me))
          ((<span class="kw">and</span> (has-value? y) (has-value? product))
           (set-value! x (<span class="fu">/</span> (get-value product) (get-value y)) me))))
  (<span class="kw">define</span> (process-forget-value)
    (forget-value! product me)
    (forget-value! x me)
    (forget-value! y me)
    (process-new-value))
  (<span class="kw">define</span> (me request)
    (<span class="kw">cond</span> ((<span class="fu">eq?</span> request <span class="vs">'I-have-a-value</span>) (process-new-value))
          ((<span class="fu">eq?</span> request <span class="vs">'I-lost-my-value</span>) (process-forget-value))
          (<span class="kw">else</span> (<span class="fu">error</span> <span class="vs">'multiplier</span> <span class="cn">"unknown request"</span> request))))
  (connect x me)
  (connect y me)
  (connect product me)
  me)

(<span class="kw">define</span> (constant value connector)
  (<span class="kw">define</span> (me request)
    (<span class="fu">error</span> <span class="vs">'constant</span> <span class="cn">"unknown request"</span> request))
  (connect connector me)
  (set-value! connector value me)
  me)

(<span class="kw">define</span> (probe name connector)
  (<span class="kw">define</span> (print-probe value)
    (<span class="fu">display</span> (format <span class="cn">"</span><span class="co">\n</span><span class="cn">Probe: ~a = ~a"</span> name value)))
  (<span class="kw">define</span> (me request)
    (<span class="kw">cond</span> ((<span class="fu">eq?</span> request <span class="vs">'I-have-a-value</span>)
           (print-probe (get-value connector)))
          ((<span class="fu">eq?</span> request <span class="vs">'I-lost-my-value</span>)
           (print-probe <span class="cn">"?"</span>))
          (<span class="kw">else</span> (<span class="fu">error</span> <span class="vs">'probe</span> <span class="cn">"unknown request"</span> request))))
  (connect connector me)
  me)</code></pre>
<h3 id="3.3.5.3" class="anchor">
<a class="anchor__link link" href="#3.3.5.3" aria-hidden="true">#</a> <span class="number">3.3.5.3</span> Representing connectors
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="../2/3.html#2.3.1">2.3.1</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>memq</code>
</li>
</ul>
</li>
</ul>
</aside>
<p>Moved here from Section 3.3.5.2 to avoid import cycle.</p>
<pre><code class="blockcode">(<span class="kw">define</span> (inform-about-value constraint)
  (constraint <span class="vs">'I-have-a-value</span>))
(<span class="kw">define</span> (inform-about-no-value constraint)
  (constraint <span class="vs">'I-lost-my-value</span>))

(<span class="kw">define</span> (make-connector)
  (<span class="kw">let</span> ((value <span class="cn">#f</span>)
        (informant <span class="cn">#f</span>)
        (constraints <span class="vs">'()</span>))
    (<span class="kw">define</span> (set-value! new-val setter)
      (<span class="kw">cond</span> ((<span class="fu">not</span> (has-value? me))
             (<span class="kw">set!</span> value new-val)
             (<span class="kw">set!</span> informant setter)
             (for-each-except setter inform-about-value constraints))
            ((<span class="fu">not</span> (<span class="fu">=</span> value new-val))
             (<span class="fu">error</span> <span class="vs">'set-value!</span> <span class="cn">"contradiction"</span> value new-val))
            (<span class="kw">else</span> <span class="vs">'ignored</span>)))
    (<span class="kw">define</span> (forget-value! retractor)
      (<span class="kw">cond</span> ((<span class="fu">eq?</span> retractor informant)
             (<span class="kw">set!</span> informant <span class="cn">#f</span>)
             (for-each-except retractor inform-about-no-value constraints))
            (<span class="kw">else</span> <span class="vs">'ignored</span>)))
    (<span class="kw">define</span> (connect new-constraint)
      (unless (<span class="fu">memq</span> new-constraint constraints)
        (<span class="kw">set!</span> constraints (<span class="fu">cons</span> new-constraint constraints)))
      (when (has-value? me)
        (inform-about-value new-constraint)))
    (<span class="kw">define</span> (me request)
      (<span class="kw">cond</span> ((<span class="fu">eq?</span> request <span class="vs">'has-value?</span>)
             (<span class="kw">if</span> informant <span class="cn">#t #f</span>))
            ((<span class="fu">eq?</span> request <span class="vs">'get-value</span>) value)
            ((<span class="fu">eq?</span> request <span class="vs">'set-value!</span>) set-value!)
            ((<span class="fu">eq?</span> request <span class="vs">'forget-value!</span>) forget-value!)
            ((<span class="fu">eq?</span> request <span class="vs">'connect</span>) connect)
            (<span class="kw">else</span> (<span class="fu">error</span> <span class="vs">'make-connector</span> <span class="cn">"unknown operation"</span> request))))
    me))

(<span class="kw">define</span> (for-each-except exception proc ls)
  (<span class="kw">define</span> (iter items)
    (unless (<span class="fu">null?</span> items)
      (unless (<span class="fu">eq?</span> (<span class="fu">car</span> items) exception)
        (proc (<span class="fu">car</span> items)))
      (iter (<span class="fu">cdr</span> items))))
  (iter ls))

(<span class="kw">define</span> (has-value? connector) (connector <span class="vs">'has-value?</span>))
(<span class="kw">define</span> (get-value connector) (connector <span class="vs">'get-value</span>))
(<span class="kw">define</span> (set-value! connector val who) ((connector <span class="vs">'set-value!</span>) val who))
(<span class="kw">define</span> (forget-value! connector who) ((connector <span class="vs">'forget-value!</span>) who))
(<span class="kw">define</span> (connect connector constraint) ((connector <span class="vs">'connect</span>) constraint))</code></pre>
<h3 id="ex3.33" class="anchor">
<a class="anchor__link link" href="#ex3.33" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.33">Exercise 3.33<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.5.2">3.3.5.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>adder</code>
</li>
<li class="flat__item nowrap">
<code>constant</code>
</li>
<li class="flat__item nowrap">
<code>multiplier</code>
</li>
<li class="flat__item nowrap">
<code>probe</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.5.3">3.3.5.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>forget-value!</code>
</li>
<li class="flat__item nowrap">
<code>make-connector</code>
</li>
<li class="flat__item nowrap">
<code>set-value!</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (averager a b c)
  (<span class="kw">let</span> ((u (make-connector))
        (w (make-connector)))
    (adder a b u)
    (multiplier c w u)
    (constant <span class="cn">2</span> w)))

(<span class="kw">define</span> a (make-connector))
(<span class="kw">define</span> b (make-connector))
(<span class="kw">define</span> c (make-connector))
(averager a b c)
(probe <span class="cn">"a"</span> a)
(probe <span class="cn">"c"</span> c)

(set-value! a <span class="cn">10</span> <span class="vs">'user</span>)
<span class="op">=$&gt;</span> [<span class="cn">"Probe: a = 10"</span>]
(set-value! b <span class="cn">20</span> <span class="vs">'user</span>)
<span class="op">=$&gt;</span> [<span class="cn">"Probe: c = 15"</span>]
(forget-value! a <span class="vs">'user</span>)
<span class="op">=$&gt;</span> [<span class="cn">"Probe: a = ?"
     "Probe: c = ?"</span>]
(set-value! c <span class="cn">99</span> <span class="vs">'user</span>)
<span class="op">=$&gt;</span> [<span class="cn">"Probe: c = 99"
     "Probe: a = 178"</span>]</code></pre>
<h3 id="ex3.34" class="anchor">
<a class="anchor__link link" href="#ex3.34" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.34">Exercise 3.34<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.5.2">3.3.5.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>multiplier</code>
</li>
<li class="flat__item nowrap">
<code>probe</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.5.3">3.3.5.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>forget-value!</code>
</li>
<li class="flat__item nowrap">
<code>make-connector</code>
</li>
<li class="flat__item nowrap">
<code>set-value!</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (bad-squarer a b)
  (multiplier a a b))</code></pre>
<p>At first glance, Louis Reasoner’s constraint seems okay:</p>
<pre><code class="blockcode">(<span class="kw">define</span> a (make-connector))
(<span class="kw">define</span> b (make-connector))
(probe <span class="cn">"a"</span> a)
(probe <span class="cn">"b"</span> b)
(bad-squarer a b)
(set-value! a <span class="cn">5</span> <span class="vs">'user</span>)
<span class="op">=$&gt;</span> [<span class="cn">"Probe: b = 25"
     "Probe: a = 5"</span>]</code></pre>
<p>However, going the other way doesn’t work:</p>
<pre><code class="blockcode">(forget-value! a <span class="vs">'user</span>)
<span class="op">=$&gt;</span> [<span class="cn">"Probe: b = ?"
     "Probe: a = ?"</span>]
(set-value! b <span class="cn">49</span> <span class="vs">'user</span>)
<span class="op">=$&gt;</span> [<span class="cn">"Probe: b = 49"</span>]</code></pre>
<p>Upon reflection, it would be remarkable if it performed a square root without us ever coding the algorithm! The problem is, <code>multiplier</code> is too general. Louis Reasoner’s constraint does not take advantage of the extra information specific to multiplications of a number to itself. It doesn’t know that the multiplicand and the multiplier are the same connector.</p>
<h3 id="ex3.35" class="anchor">
<a class="anchor__link link" href="#ex3.35" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.35">Exercise 3.35<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="../1/1.html#1.1.4">1.1.4</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>square</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.5.2">3.3.5.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>probe</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.5.3">3.3.5.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>connect</code>
</li>
<li class="flat__item nowrap">
<code>forget-value!</code>
</li>
<li class="flat__item nowrap">
<code>get-value</code>
</li>
<li class="flat__item nowrap">
<code>has-value?</code>
</li>
<li class="flat__item nowrap">
<code>make-connector</code>
</li>
<li class="flat__item nowrap">
<code>set-value!</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (squarer a b)
  (<span class="kw">define</span> (process-new-value)
    (<span class="kw">cond</span> ((has-value? a)
           (set-value! b (square (get-value a)) me))
          ((has-value? b)
           (<span class="kw">if</span> (<span class="fu">&lt;</span> (get-value b) <span class="cn">0</span>)
               (<span class="fu">error</span> <span class="vs">'squarer</span> <span class="cn">"square less than 0"</span> (get-value b))
               (set-value! a (<span class="fu">sqrt</span> (get-value b)) me)))))
  (<span class="kw">define</span> (process-forget-value)
    (forget-value! b)
    (forget-value! a)
    (process-new-value))
  (<span class="kw">define</span> (me request)
    (<span class="kw">cond</span> ((<span class="fu">eq?</span> request <span class="vs">'I-have-a-value</span>) (process-new-value))
          ((<span class="fu">eq?</span> request <span class="vs">'I-lost-my-value</span>) (process-forget-value))
          (<span class="kw">else</span> (<span class="fu">error</span> <span class="vs">'squarer</span> <span class="cn">"unknown request"</span> request))))
  (connect a me)
  (connect b me)
  me)

(<span class="kw">define</span> a (make-connector))
(<span class="kw">define</span> b (make-connector))
(probe <span class="cn">"a"</span> a)
(squarer a b)
(set-value! b <span class="cn">49</span> <span class="vs">'user</span>) <span class="op">=$&gt;</span> [<span class="cn">"Probe: a = 7"</span>]</code></pre>
<h3 id="ex3.36" class="anchor">
<a class="anchor__link link" href="#ex3.36" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.36">Exercise 3.36<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<p>See whiteboard/exercise-3.36.jpg for the environment diagram.</p>
<h3 id="ex3.37" class="anchor">
<a class="anchor__link link" href="#ex3.37" aria-hidden="true">#</a> <a class="link" href="https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book-Z-H-22.html#%25_thm_3.37">Exercise 3.37<span class="nowrap">⁠<svg class="external" width="24" height="24" aria-hidden="true"><use xlink:href="#external"/></svg></span></a>
</h3>
<aside class="imports">
<h4>
Imports:
</h4>
<ul class="flat">
<li class="flat__item">
<a href="#3.3.5.2">3.3.5.2</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>adder</code>
</li>
<li class="flat__item nowrap">
<code>constant</code>
</li>
<li class="flat__item nowrap">
<code>multiplier</code>
</li>
<li class="flat__item nowrap">
<code>probe</code>,
</li>
</ul>
</li>
<li class="flat__item">
<a href="#3.3.5.3">3.3.5.3</a>
<ul class="flat">
<li class="flat__item nowrap">
<code>make-connector</code>
</li>
<li class="flat__item nowrap">
<code>set-value!</code>
</li>
</ul>
</li>
</ul>
</aside>
<pre><code class="blockcode">(<span class="kw">define</span> (celsius-&gt;fahrenheit x)
  (c+ (c* (c/ (cv <span class="cn">9</span>) (cv <span class="cn">5</span>))
          x)
      (cv <span class="cn">32</span>)))

(<span class="kw">define</span> (cv val) (<span class="kw">let</span> ((c (make-connector))) (constant val c) c))
(<span class="kw">define</span> (c+ x y) (<span class="kw">let</span> ((z (make-connector))) (adder x y z) z))
(<span class="kw">define</span> (c- x y) (<span class="kw">let</span> ((z (make-connector))) (adder y z x) z))
(<span class="kw">define</span> (c* x y) (<span class="kw">let</span> ((z (make-connector))) (multiplier x y z) z))
(<span class="kw">define</span> (c/ x y) (<span class="kw">let</span> ((z (make-connector))) (multiplier y z x) z))

(<span class="kw">define</span> C (make-connector))
(<span class="kw">define</span> F (celsius-&gt;fahrenheit C))
(probe <span class="cn">"C"</span> C)
(set-value! F <span class="cn">212</span> <span class="vs">'user</span>) <span class="op">=$&gt;</span> [<span class="cn">"Probe: C = 100"</span>]</code></pre>
</main>
<nav class="pagenav pagenav--bottom" aria-label="page">
  <div class="pagenav__item pagenav__item--left">
    <a class="pagenav__link link" href="2.html" aria-label="previous page">
      <svg width="12" height="11" aria-hidden="true"><use xlink:href="#left"/>
      </svg><span class="pagenav__prev">Prev</span>
    </a>
  </div>
  <div class="pagenav__item pagenav__item--center">
    <a class="pagenav__link link" href="index.html" aria-label="parent page">
      <svg width="11" height="12" aria-hidden="true"><use xlink:href="#up"/>
      </svg><span class="pagenav__up">Up</span>
    </a>
  </div>
  <div class="pagenav__item pagenav__item--right">
    <a class="pagenav__link link" href="4.html" aria-label="next page">
      <span class="pagenav__next">Next</span
        ><svg width="12" height="11" aria-hidden="true"
        ><use xlink:href="#right"/></svg>
    </a>
  </div>
</nav>
<footer class="footer">
  <p>© 2022 Mitchell Kember</p>
</footer>
</body>
</html>
